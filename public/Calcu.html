<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ¨™æº–ãƒ»çŸ­æ™‚é–“ åˆ‡ã‚Šæ›¿ãˆè¨ˆç®—</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      color-scheme: light;
      --accent: #2563eb;
      --muted: #f4f4f5;
      --border: #d4d4d8;
      --text: #111827;
      --subtext: #4b5563;
      --weekend-bg: #fee2e2;
      --weekday-bg: #eef2ff;
      --btn5: #0ea5e9;
      --btn1: #22c55e;
    }
/* ===== åŒºåˆ†ã”ã¨è‰²åˆ†ã‘ ===== */
/* å‚™è€ƒåˆ—ã‚’å›ºå®šå¹…ã«ã™ã‚‹ */
td.col-remark, th.col-remark {
  width: 100px;        /* â† å¥½ããªå¹…ã«èª¿æ•´ï¼ˆä¾‹: 100ã€œ150pxï¼‰ */
  min-width: 100px;
  max-width: 100px;
  word-break: break-word;   /* é•·æ–‡ã§ã‚‚å´©ã‚Œãªã„ */
  white-space: normal;      /* å¿…ãšæŠ˜ã‚Šè¿”ã™ */
  text-align: left;         /* è¦‹æ „ãˆã‚ˆãå·¦å¯„ã› */
}
/* ä¸Šã®ã€Œåœ’ï¼ã‚¯ãƒ©ã‚¹ï¼æ°åï¼åŸºæœ¬åŒºåˆ†ã€ã¾ã¨ã‚ãƒ–ãƒ­ãƒƒã‚¯ */
.selection-panel {
  margin-bottom: 8px;
}
/* é ã‹ã‚Šä¿è‚²ã‚»ãƒ«ï¼ˆå³å¯„ã›2åˆ—ï¼šé ã‹ã‚Šä¿è‚² / é ã‹ã‚Šä¿è‚²æ–™é‡‘ï¼‰ */
.col-azukari,
.col-azukarif {
  text-align: center;
  vertical-align: middle;
  width: 90px;
}
/* åˆ—ãƒªã‚µã‚¤ã‚ºç”¨ãƒãƒ³ãƒ‰ãƒ« */
.resizable-header {
  position: relative;
}
.column-resizer {
  position: absolute;
  top: 0;
  right: -4px;
  width: 8px;
  height: 100%;
  cursor: col-resize;
  user-select: none;
  touch-action: none;
}
.column-resizer::after {
  content: "";
  position: absolute;
  inset: 0;
}
/* åˆ—ã®è¡¨ç¤º/éè¡¨ç¤ºãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.column-menu-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1200;
}
.column-menu-backdrop.open {
  display: flex;
}
.column-menu {
  background: #fff;
  border-radius: 12px;
  padding: 12px;
  width: min(320px, calc(100% - 40px));
  box-shadow: 0 18px 36px rgba(15, 23, 42, 0.24);
  border: 1px solid var(--border);
  font-size: 13px;
}
.column-menu-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-weight: 700;
}
.column-menu-close {
  background: transparent;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: var(--subtext);
}
.column-menu-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 8px;
}
.column-menu-list label {
  display: flex;
  align-items: center;
  gap: 6px;
}
/* åˆè¨ˆï¼ˆé»„è‰²ã®ãƒœãƒƒã‚¯ã‚¹ï¼‰ */
.azukari-total {
  background: #fef9c3;        /* ãƒ¬ãƒ¢ãƒ³è‰² */
  border: 1px solid #facc15;  /* é»„è‰²æ  */
  padding: 4px 6px;
  border-radius: 6px;
  font-weight: 700;
  margin-bottom: 4px;
  font-size: 12px;
}
/* ãƒœã‚¿ãƒ³é…ç½® */
.azukari-buttons {
  display: flex;
  gap: 4px;
  justify-content: center;
}
/* -15åˆ†ï¼ˆé’ï¼‰ */
.azukariBtn.minus {
  background: #3b82f6;   /* é’ */
  color: white;
  border-radius: 6px;
  padding: 2px 8px;
  font-size: 11px;
  border: none;
}
/* +15åˆ†ï¼ˆç·‘ï¼‰ */
.azukariBtn.plus {
  background: #22c55e;   /* ç·‘ */
  color: white;
  border-radius: 6px;
  padding: 2px 8px;
  font-size: 11px;
  border: none;
}
/* ãƒ›ãƒãƒ¼åŠ¹æœ */
.azukariBtn:hover {
  opacity: 0.85;
}
/* 1è¡Œï¼ˆåœ’ï¼šã€‡ã€‡â€¦ ã®1è¡Œï¼‰ */
.selection-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 4px;
  font-size: 13px;
}
/* å·¦å´ã®ã€Œåœ’ï¼šã€ã€Œã‚¯ãƒ©ã‚¹ï¼šã€ãƒ©ãƒ™ãƒ«éƒ¨åˆ†ï¼ˆå³ãã‚ãˆï¼‰ */
.selection-row-label {
  width: 60px;            /* ã‚¯ãƒ©ã‚¹ï¼šãŒåã¾ã‚‹ãã‚‰ã„ã®å¹…ã§å›ºå®š */
  text-align: right;
  font-weight: 600;
  color: var(--subtext);
  flex-shrink: 0;
}
/* å³å´ã®å†…å®¹ï¼ˆãƒœã‚¿ãƒ³ã‚„åå‰ï¼‰éƒ¨åˆ†ï¼ˆå·¦ãã‚ãˆï¼‰ */
.selection-row-value {
  flex: 1;
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
  text-align: left;
}
/* æ°åã®ä¸­ã§åå‰ãƒãƒƒãƒ—ã‚’ä¸¦ã¹ãŸã„æ™‚ç”¨ï¼ˆå¿…è¦ãªã‚‰ï¼‰ */
.selection-row-value .name-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.type-standard {
  background: #eff6ff;
  border-color: #3b82f6;
  color: #1e40af;
}
.type-standard.active {
  background: #3b82f6;
  color: #fff;
}
/* çŸ­æ™‚é–“ â†’ ã‚ªãƒ¬ãƒ³ã‚¸ */
.type-short {
  background: #fff7ed;
  border-color: #fb923c;
  color: #c2410c;
}
.type-short.active {
  background: #fb923c;
  color: #fff;
}
/* ã€Œåœ’:ã€ã€Œã‚¯ãƒ©ã‚¹:ã€ã®è¡Œãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
/* ã€Œåœ’:ã€ã€Œã‚¯ãƒ©ã‚¹:ã€ã€Œæ°å:ã€è¡Œã‚’ãã‚ãˆã‚‹ */
.school-tabs,
.class-tabs,
.tabs {
  display: flex;
  flex-wrap: wrap;
  align-items: flex-start;
  gap: 6px;
  margin-bottom: 8px;
}
/* å·¦å´ã®ãƒ©ãƒ™ãƒ«ï¼ˆåœ’: / ã‚¯ãƒ©ã‚¹: / æ°å:ï¼‰ã‚’å³å¯„ã›ï¼†å¹…å›ºå®š */
.school-tabs > .muted,
.class-tabs  > .muted,
.tabs        > .muted {
  width: 50px;           /* ã€Œã‚¯ãƒ©ã‚¹:ã€ã€ŒåŸºæœ¬åŒºåˆ†:ã€ãŒå…¥ã‚‹å¹…ã«å›ºå®š */
  text-align: right;     /* å³æƒãˆ */
  font-weight: 600;
  color: var(--subtext);
  flex-shrink: 0;
  padding-top: 4px;      /* ãƒœã‚¿ãƒ³ã¨é«˜ã•ã‚’ãã‚ãˆã‚‹ãŸã‚å°‘ã—ä¸‹ã’ã‚‹ */
}
/* å³å´ã®ãƒœã‚¿ãƒ³ãŸã¡ã¯ä»Šã¾ã§é€šã‚Šï¼ˆå·¦å¯„ã›ï¼‰ */
.school-tab,
.class-tab,
.tab-button {
  /* æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§OKï¼ˆpadding / border / background ãªã©ï¼‰ */
}
/* é …ç›®åï¼ˆåœ’ãƒ»ã‚¯ãƒ©ã‚¹ãƒ»æ°åãƒ»åŸºæœ¬åŒºåˆ†ï¼‰ã®å·¦å³ãã‚ãˆç”¨ */
.selection-row {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  margin-bottom: 4px;
  font-size: 13px;
}
.selection-row-label {
  width: 56px;          /* ã€Œã‚¯ãƒ©ã‚¹ï¼šã€ãã‚‰ã„ãŒå…¥ã‚‹å¹… */
  text-align: right;    /* ãƒ©ãƒ™ãƒ«ã¯å³å¯„ã› */
  font-weight: 600;
  color: var(--subtext);
  flex-shrink: 0;
}
.selection-row-value {
  flex: 1;
  text-align: left;     /* ä¸­èº«ã¯å·¦å¯„ã› */
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
/* æ°åã®ä¸­ã§ãƒãƒƒã‚¸ã‚„åå‰ã‚’ä¸¦ã¹ã‚‹ã¨ã */
.selection-row-value .name-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
/* åŸºæœ¬åŒºåˆ†ãƒ©ãƒ™ãƒ«è¡Œã®ä½™ç™½ã¡ã‚‡ã£ã¨ã ã‘ä¸Šã« */
.selection-row.selection-row-basic {
  margin-top: 6px;
}
/* è¡Œé ­ãƒ©ãƒ™ãƒ«ï¼ˆåœ’: / ã‚¯ãƒ©ã‚¹:ï¼‰ã‚’ãã‚ãˆã‚‹ */
.school-tabs > .muted,
.class-tabs  > .muted {
  min-width: 3.5em;        /* åŒã˜å¹…ã«ã—ã¦ãã‚ãˆã‚‹ */
  text-align: right;
  font-weight: 600;
  color: var(--subtext);
}
/* åœ’ãƒ»ã‚¯ãƒ©ã‚¹ã®ã‚¿ãƒ–å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæœªé¸æŠã§ã‚‚ã¡ã‚ƒã‚“ã¨è¦‹ãˆã‚‹ï¼‰ */
.school-tab,
.class-tab {
  padding: 4px 12px;
  border-radius: 999px;
  border: 1px solid #d1d5db;
  background: #f9fafb;
  font-size: 13px;
  cursor: pointer;
  color: #4b5563;
}
/* é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚¿ãƒ– */
.school-tab.active,
.class-tab.active {
  background: #2563eb;
  border-color: #2563eb;
  color: #fff;
}
/* éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã¯å°‘ã—ã ã‘è–„ãï¼ˆæ¶ˆãˆãªã„ç¨‹åº¦ï¼‰ */
.school-tab:not(.active),
.class-tab:not(.active) {
  opacity: 0.85;
}
.class-tab:hover {
  background: #e2e8f0;         /* â† ãƒ›ãƒãƒ¼æ™‚ã«è–„ã„ã‚°ãƒ¬ãƒ¼ã§ã‚ã‹ã‚Šã‚„ã™ã */
}
.class-tab.active {
  background: #2563eb;         /* â† é¸æŠä¸­ã®é’ï¼ˆãã®ã¾ã¾ï¼‰ */
  border-color: #2563eb;
  color: #fff;
}
/* 1å·ä¿è‚² â†’ ã‚°ãƒªãƒ¼ãƒ³ */
.type-1gou {
  background: #ecfdf5;
  border-color: #34d399;
  color: #065f46;
}
.type-1gou.active {
  background: #34d399;
  color: #fff;
}
/* 2å·ä¿è‚² â†’ ãƒ‘ãƒ¼ãƒ—ãƒ« */
.type-2gou {
  background: #f5f3ff;
  border-color: #a78bfa;
  color: #5b21b6;
}
.type-2gou.active {
  background: #a78bfa;
  color: #fff;
}
/* 3å·ä¿è‚² â†’ ãƒ”ãƒ³ã‚¯ */
.type-3gou {
  background: #fdf2f8;
  border-color: #f472b6;
  color: #831843;
}
.type-3gou.active {
  background: #f472b6;
  color: #fff;
}
/* æ¨™æº–ï¼ˆé’ç³»ï¼‰ */
.daycard.type-standard {
  background:#eff6ff;
}
.daycard.type-standard::before {
  background:#3b82f6;
}
/* çŸ­æ™‚é–“ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ç³»ã«ã—ãŸã„ãªã‚‰ï¼‰ */
.daycard.type-short {
  background:#fff7ed;
}
.daycard.type-short::before {
  background:#fb923c;
}
/* 1å·ä¿è‚²ï¼ˆã‚°ãƒªãƒ¼ãƒ³ï¼‰ */
.daycard.type-1gou {
  background:#ecfdf5;
}
.daycard.type-1gou::before {
  background:#34d399;
}
/* 2å·ä¿è‚²ï¼ˆãƒ‘ãƒ¼ãƒ—ãƒ«ï¼‰ */
.daycard.type-2gou {
  background:#f5f3ff;
}
.daycard.type-2gou::before {
  background:#a78bfa;
}
/* 3å·ä¿è‚²ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰ */
.daycard.type-3gou {
  background:#fdf2f8;
}
.daycard.type-3gou::before {
  background:#f472b6;
}
    * { box-sizing: border-box; }
    body {
      font-family:"Noto Sans JP",system-ui,-apple-system,"Segoe UI",sans-serif;
      margin:0;
      padding:0;
      background:#fff;
      color:var(--text);
      line-height:1.5;
    }
    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
    header {
      background:linear-gradient(120deg,var(--accent),#38bdf8);
      color:#fff;
      padding:14px 20px;
      box-shadow:0 2px 12px rgba(0,0,0,0.12);
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
    }
    .logo-circle {
      width:40px;height:40px;border-radius:50%;
      background:#fff;color:#2563eb;
      display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:18px;
      box-shadow:0 2px 6px rgba(0,0,0,0.18);
    }
    header h1 {
      margin:0;font-size:20px;font-weight:700;
    }
    header p {
      margin:2px 0 0;font-size:12px;color:rgba(255,255,255,0.9);
    }
    .sidebar-toggle {
      position:absolute;right:20px;top:16px;
    }
    /* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
    main {
      padding:20px;
      max-width:1200px;
      margin:0 auto 80px;
      display:grid;
      grid-template-columns:minmax(260px,320px) 1fr;
      gap:16px;
      align-items:flex-start;
    }
    body.sidebar-collapsed main { grid-template-columns:1fr; }
    body.sidebar-collapsed .sidebar { display:none; }
    .panel {
      background:#fff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
      box-shadow:0 6px 20px rgba(15,23,42,0.06);
    }
    .panel h2 { margin:0 0 10px;font-size:18px;font-weight:700; }
    label {
      display:block;
      font-weight:600;
      margin-bottom:6px;
      color:var(--subtext);
    }
    input[type="file"],
    input[type="number"],
    button {
      font:inherit;
    }
    input[type="file"],
    input[type="number"] {
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:8px;
      background:#fff;
      transition:border-color .15s,box-shadow .15s;
    }
    input[type="file"] { padding:8px 12px; }
    input:focus {
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(37,99,235,.16);
    }
    .grid { display:grid;gap:14px; }
    .grid.two { grid-template-columns:1fr; }
    button {
      cursor:pointer;
      border:none;
      border-radius:10px;
      padding:12px 16px;
      font-weight:700;
      color:#fff;
      background:var(--accent);
      transition:transform .1s,box-shadow .1s,background .2s;
    }
    button.secondary { background:#0ea5e9; }
    button.small {
      padding:4px 10px;
      font-size:11px;
      border-radius:999px;
      box-shadow:none;
      min-width:60px;
      text-align:center;
    }
    button:disabled { opacity:.6;cursor:not-allowed; }
    button:hover:not(:disabled) {
      transform:translateY(-1px);
      box-shadow:0 6px 14px rgba(37,99,235,.25);
    }
    button.small:hover:not(:disabled) {
      transform:none;
      box-shadow:none;
    }
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      background:#fff;
    }
/* æ—¥ã®åˆ—ã®å¹…ã‚’å›ºå®šã—ã¦ç´°ãã™ã‚‹ */
th.col-day,
td.col-day {
  width: 96px;   /* ã‚†ã£ãŸã‚Šè¡¨ç¤ºã§ãã‚‹ã‚ˆã†å°‘ã—åºƒã‚ã« */
  padding: 0;
}
.col-day .daycard {
  width: 92px;   /* ã‚«ãƒ¼ãƒ‰è‡ªä½“ã®å¹… */
  height: 130px;  /* é«˜ã•ã‚‚ãã‚ãˆã‚‹ */
  margin: 0px auto;
}
    th,td {
      border:1px solid var(--border);
      padding:6px 8px;
      font-size:13px;
      vertical-align:middle;
      word-break:break-word;
    }
    .col-remark .remark-text {
      font-size:11px;
      margin-bottom:2px;
      white-space:nowrap;   /* â˜… ã“ã“ã‚’è¿½åŠ  */
    }
/* å‚™è€ƒã‚»ãƒ«ï¼šä¸­èº«ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
.col-remark {
  padding: 6px;
  vertical-align: top;
}
/* å‚™è€ƒãƒ†ã‚­ã‚¹ãƒˆ */
.remark-text {
  margin-bottom: 6px;
  white-space: nowrap;
}
/* ãƒœã‚¿ãƒ³ã‚’å·¦ä¸‹ã«è‡ªç„¶é…ç½® */
.remark-actions {
  display: flex;
  flex-direction: column;  /* â† ç¸¦ã«ä¸¦ã¹ã‚‹ */
  align-items: flex-start; /* â† å·¦å¯„ã› */
  gap: 2px;                /* â† ãƒœã‚¿ãƒ³ã®ä¸Šä¸‹ã®ã™ãé–“ */
}
/* æ—¥ã”ã¨ã®ã€Œå…ƒã«æˆ»ã™ã€ãƒœã‚¿ãƒ³ */
.resetRowBtn {
  display:inline-block;
  margin-left:4px;
  margin-top:2px;
  padding:2px 8px;
  font-size:10px;
  border-radius:999px;
  border:1px solid #d1d5db;
  background:#f9fafb;
  color:#6b7280;
  cursor:default;
  transition:background 0.15s, color 0.15s, border-color 0.15s, transform 0.08s, box-shadow 0.08s;
}
/* â‘  å¤‰æ›´ãªã—ï¼šè–„ã„ã‚°ãƒ¬ãƒ¼ã§ã€ŒæŠ¼ã›ãªã•ãã†ã€ */
.resetRowBtn.no-change {
  opacity:0.5;
}
/* â‘¡ å¤‰æ›´ã‚ã‚Šï¼šé’ç³»ã§æŠ¼ã›ã‚‹æ„Ÿ */
.resetRowBtn.has-change {
  cursor:pointer;
  opacity:1;
  background:#eff6ff;
  border-color:#2563eb;
  color:#1d4ed8;
}
/* â‘¢ ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ï¼šå°‘ã—æ¿ƒãï¼†å½± */
.resetRowBtn.has-change:hover {
  background:#dbeafe;
  box-shadow:0 0 0 1px rgba(37,99,235,0.15);
}
/* â‘£ ã‚¯ãƒªãƒƒã‚¯ä¸­ï¼šã¡ã‚‡ã£ã¨æŠ¼ã—è¾¼ã‚€ */
.resetRowBtn.has-change:active {
  transform:translateY(1px) scale(0.97);
  box-shadow:none;
}
/* â‘¤ ã‚¯ãƒªãƒƒã‚¯å¾Œï¼ˆãƒªã‚»ãƒƒãƒˆç›´å¾Œã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”¨ï¼‰ */
.resetRowBtn.done {
  background:#dcfce7;
  border-color:#16a34a;
  color:#166534;
}
/* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç™½æŠœãï¼ˆæ ã®ã¿ï¼‰ */
.copyRemarkBtn {
  display:inline-block;
  margin-top:2px;
  padding:2px 8px;
  font-size:10px;
  border-radius:999px;
  border:1px solid #d1d5db;
  background:transparent;
  color:#4b5563;
  cursor:pointer;
  transition:background 0.15s, color 0.15s, border-color 0.15s, transform 0.08s, box-shadow 0.08s;
}
/* ãƒ›ãƒãƒ¼æ™‚ï¼ˆè–„ã„é’ï¼‰ */
.copyRemarkBtn:hover {
  background:#e0f2fe;
  border-color:#38bdf8;
  color:#0369a1;
}
/* ã‚¯ãƒªãƒƒã‚¯ä¸­ï¼ˆã¡ã‚‡ã£ã¨æŠ¼ã—è¾¼ã‚€ï¼‰ */
.copyRemarkBtn:active {
  transform:translateY(1px) scale(0.97);
  box-shadow:none;
}
    /* æ—¥ä»˜ã‚»ãƒ«ã ã‘ã¯ä½™ç™½ãƒŠã‚·ï¼‹æ ãƒŠã‚·ã«ã™ã‚‹ */
    td.col-day {
      padding:0;
      border:none;
    }
    th {
      background:var(--muted);
      text-align:left;
      font-weight:700;
    }
    caption {
      text-align:left;
      font-weight:700;
      margin-bottom:8px;
    }
    .chip {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      background:var(--muted);
      border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      color:var(--subtext);
      margin-right:6px;
      margin-bottom:4px;
    }
    .muted { color:var(--subtext);font-size:13px; }
    .tabs {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:10px;
    }
    .tab-button {
      padding:8px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#f9fafb;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      color:var(--subtext);
    }
    .tab-button.active {
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .tab-panel { display:none; }
    .tab-panel.active { display:block; }
    .date-cell {
      font-weight:700;
      background:var(--weekday-bg);
    }
    .date-cell.weekend {
      background:var(--weekend-bg);
      color:#b91c1c;
    }
    /* ==== ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆå·¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ä»˜ãï¼‰ ==== */
    .daycard {
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:2px 0;
      border-radius:6px;
      background:#ffffff;
      border:1px solid #e5e7eb;
      width:75px;          /* â‘ ã¨åˆã‚ã›ã‚‹ */
      height:122px;
      box-sizing:border-box;
      margin:0 auto;
      position:relative;   /* â˜… å·¦ãƒãƒ¼ç”¨ã«å¿…é ˆ */
    }
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæ¨™æº–ï¼ˆé’ï¼‰ */
    .daycard::before {
      content:"";
      position:absolute;
      left:0;
      top:0;
      width:4px;
      height:100%;
      border-radius:4px 0 0 4px;
      background:#3b82f6;  /* æ¨™æº–ï¼šé’ */
    }
    /* ä¼‘åœ’ï¼šã‚°ãƒ¬ãƒ¼ */
    .daycard.status-closed::before {
      background:#9ca3af;
    }
    /* æ¬ åœ’ï¼šèµ¤ */
    .daycard.status-absent::before {
      background:#ef4444;
    }
    .daycard-week {
      font-size:10px;
      font-weight:600;
      color:#6b7280;
      padding:1px 0;
    }
    .daycard-date {
      font-size:16px;
      font-weight:700;
      color:#111827;
      padding:1px 0;
    }
    .daycard-status {
      padding-top:2px;
    }
    /* æ—¥ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«å‡ºã™å¤‰æ›´ã‚¿ã‚°ç”¨ */
    .daycard-tags {
      margin-top:2px;
      display:flex;
      flex-wrap:wrap;
      gap:2px;
      justify-content:center;
      min-height:18px;
    }
    .day-tag {
      display:inline-block;
      padding:0 6px;
      border-radius:999px;
      background:transparent;
      color:#9ca3af;
      font-size:9px;
      line-height:1.6;
      border:1px solid #d1d5db;
    }
    .day-tag-type.active {
      background:#3b82f6;
      color:#ffffff;
      border-color:#3b82f6;
    }
    .day-tag-time.active {
      background:#f97316;
      color:#ffffff;
      border-color:#f97316;
    }
    .time-cell {
      white-space:nowrap;
      text-align:center;
      vertical-align:middle;
    }
    .time-buttons {
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:2px;
      align-items:center;
    }
    .time-buttons-row {
      display:flex;
      flex-wrap:nowrap;
      gap:4px;
      justify-content:center;
    }
    .time-buttons-row.row-5 button { background:var(--btn5); }
    .time-buttons-row.row-1 button { background:var(--btn1); }
    .time-buttons-row button.small {
      min-width:60px;
      padding:4px 0;
    }
    .time-input {
      width:80px;
      font-size:13px;
      padding:3px 6px;
      border-radius:6px;
      border:1px solid var(--border);
      margin:0 auto 2px;
      text-align:center;
    }
    td.col-leave {
      font-size:16px;
      font-weight:600;
    }
    .col-type,
    .col-weekday {
      text-align:center;
    }
    .col-over,
    .col-extu,
    .col-extf,
    .col-azukarif,
    .col-totalf {
      text-align:right;
    }
    .log-list {
      list-style:none;
      padding-left:0;
      font-size:12px;
      margin:4px 0 0;
    }
    .log-list li { margin:2px 0; }
    tr.row-selected td {
      outline:2px solid #38bdf8;
      outline-offset:-2px;
    }
    tr.row-standard td {
      background:#eff6ff;
    }
    tr.row-short td {
      background:#ecfdf3;
    }
/* æ¨™æº– è¡ŒèƒŒæ™¯ï¼ˆé’ç³»ï¼‰ */
tr.row-standard td {
  background:#eff6ff;
}
/* çŸ­æ™‚é–“ è¡ŒèƒŒæ™¯ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰ */
tr.row-short td {
  background:#fff7ed;
}
/* 1å·ä¿è‚² è¡ŒèƒŒæ™¯ï¼ˆã‚°ãƒªãƒ¼ãƒ³ï¼‰ */
tr.row-1gou td {
  background:#ecfdf5;
}
/* 2å·ä¿è‚² è¡ŒèƒŒæ™¯ï¼ˆãƒ‘ãƒ¼ãƒ—ãƒ«ï¼‰ */
tr.row-2gou td {
  background:#f5f3ff;
}
/* 3å·ä¿è‚² è¡ŒèƒŒæ™¯ï¼ˆãƒ”ãƒ³ã‚¯ï¼‰ */
tr.row-3gou td {
  background:#fdf2f8;
}
    .hide-h-year    th.col-year,    .hide-h-year    td.col-year    {display:none;}
    .hide-h-month   th.col-month,   .hide-h-month   td.col-month   {display:none;}
    .hide-h-day     th.col-day,     .hide-h-day     td.col-day     {display:none;}
    .hide-h-weekday th.col-weekday, .hide-h-weekday td.col-weekday {display:none;}
    .hide-h-type    th.col-type,    .hide-h-type    td.col-type    {display:none;}
    .hide-h-end     th.col-end,     .hide-h-end     td.col-end     {display:none;}
    .hide-h-buffer  th.col-buffer,  .hide-h-buffer  td.col-buffer  {display:none;}
    .hide-h-arrive  th.col-arrive,  .hide-h-arrive  td.col-arrive  {display:none;}
    .hide-h-leave   th.col-leave,   .hide-h-leave   td.col-leave   {display:none;}
    .hide-h-azukari   th.col-azukari,   .hide-h-azukari   td.col-azukari   {display:none;}
    .hide-h-over    th.col-over,    .hide-h-over    td.col-over    {display:none;}
    .hide-h-extu    th.col-extu,    .hide-h-extu    td.col-extu    {display:none;}
    .hide-h-extf    th.col-extf,    .hide-h-extf    td.col-extf    {display:none;}
    .hide-h-azukarif th.col-azukarif, .hide-h-azukarif td.col-azukarif {display:none;}
    .hide-h-remark th.col-remark, .hide-h-remark td.col-remark {display:none;}
    details.options summary {
      cursor:pointer;
      list-style:none;
      font-weight:600;
      font-size:13px;
    }
    details.options summary::-webkit-details-marker {display:none;}
    details.options summary::before {
      content:"â–¼";
      display:inline-block;
      font-size:10px;
      margin-right:6px;
      transform:rotate(-90deg);
      transition:transform .15s ease;
    }
    details.options[open] summary::before { transform:rotate(0deg); }
    .date-range { font-weight:700;margin-bottom:6px; }
    .help-link {
      font-size:12px;
      margin-left:6px;
      cursor:pointer;
      color:#eff6ff;
      text-decoration:underline;
    }
    .help-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .help-box{
      background:#fff;
      border-radius:12px;
      padding:16px;
      max-width:380px;
      width:calc(100% - 40px);
      box-shadow:0 20px 40px rgba(15,23,42,0.35);
      border:1px solid var(--border);
      font-size:13px;
    }
    .help-box h3{margin:0 0 8px;font-size:14px;font-weight:700;}
    .help-box img{max-width:100%;border-radius:8px;border:1px solid #e5e7eb;}
    .help-footer{display:flex;justify-content:flex-end;margin-top:8px;}
    tr.detail-row { cursor:pointer; }
/* è¡Œã”ã¨ã®åŒºåˆ†ãƒœã‚¿ãƒ³ï¼ˆæ¨™æº–æ™‚é–“ / çŸ­æ™‚é–“ / 1å·èªå®šï¼‰ */
td.col-type {
  text-align: center;
  vertical-align: middle;
}
/* åŒºåˆ†ãƒœã‚¿ãƒ³ã®ç¸¦é…ç½®ï¼†ä¸­å¤®æƒãˆ */
.type-toggle {
  display: flex;
  flex-direction: column;     /* â†ç¸¦ä¸¦ã³ */
  align-items: center;        /* â†å·¦å³ä¸­å¤® */
  justify-content: center;    /* â†ä¸Šä¸‹ä¸­å¤® */
  gap: 4px;
  width: 100%;                /* â†ã‚»ãƒ«å¹…ã«åˆã‚ã›ã‚‹ */
}
/* ãƒœã‚¿ãƒ³æœ¬ä½“ */
.type-toggle .typeBtn {
  width: 90px;                /* â†ãƒœã‚¿ãƒ³å¹…ã‚’å°ã•ãå›ºå®š */
  padding: 4px 2px;
  font-size: 10px;            /* â†å°ã•ã‚ãƒ•ã‚©ãƒ³ãƒˆ */
  text-align: center;
  line-height: 1.1;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  white-space: normal;        /* â†2è¡Œè¡¨ç¤ºOK */
}
/* 2è¡Œè¡¨ç¤ºã®ãŸã‚ */
.typeBtn span {
  display: block;
}
.type-toggle .typeBtn.active {
  border-width: 1px;
}
/* åŸºæœ¬åŒºåˆ†ãƒˆã‚°ãƒ«ï¼ˆæ¨ªä¸¦ã³ï¼‰ */
.person-type-toggle {
  display: flex;
  gap: 6px;
  margin-bottom: 6px;
  justify-content: left; /* â† ä¸­å¤®å¯„ã› */
}
/* æœªé¸æŠã®ãƒœã‚¿ãƒ³ï¼ˆä»–ã® UI ã¨åŒã˜ï¼‰ */
.personTypeBtn {
  border-radius: 999px;
  padding: 6px 10px;
  font-size: 11px;
  background: #f3f4f6;  /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
  color: #6b7280;        /* ã‚°ãƒ¬ãƒ¼æ–‡å­— */
  border: 1px solid #d1d5db;
  cursor: pointer;
}
/* é¸æŠã•ã‚ŒãŸãƒœã‚¿ãƒ³ï¼ˆactiveï¼‰ï¼é’ã§çµ±ä¸€ */
.personTypeBtn.active {
  background: #2563eb;
  color: #fff;
  border-color: #2563eb;
}
.person-type-toggle .personTypeBtn {
  min-width: 90px;        /* ãƒœã‚¿ãƒ³å¹…ã¡ã‚‡ã£ã¨å°ã•ã‚ */
  padding: 4px 6px;
  font-size: 11px;
  text-align: center;
}
.person-type-toggle .personTypeBtn.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}
    .status-pill {
      display:inline-block;
      padding:1px 8px;
      border-radius:999px;
      border:1px solid #6b7280;
      background:#ffffff;
      font-size:11px;
      line-height:1.4;
    }
    .status-pill-attend {
      border-color:#16a34a;
      color:#166534;
    }
    .status-pill-absent {
      border-color:#b91c1c;
      color:#7f1d1d;
    }
    .status-pill-closed {
      border-color:#ea580c;
      color:#9a3412;
    }
    .status-pill-leave {
      border-color:#0ea5e9;
      color:#0369a1;
    }
/* [VACATION] é•·æœŸä¼‘æš‡ã®ãƒ”ãƒ«ã¨èƒŒæ™¯ */
.status-pill-vacation {  /* [VACATION] */
  border-color: #f59e0b; /* [VACATION] */
  color: #92400e;        /* [VACATION] */
  background: #fffbeb;   /* [VACATION] */
}                        /* [VACATION] */
.daycard.status-vacation {    /* [VACATION] */
  background: #ffffff;        /* [VACATION] */
}                             /* [VACATION] */
.daycard.status-vacation::before { /* [VACATION] */
  background: #e5e7eb;            /* [VACATION] */
}                                  /* [VACATION] */
.row-vacation td { /* [VACATION] */
  background: #ffffff !important;
}
.day-tag-vacation.active { /* [VACATION] */
  background: #f59e0b;
  color: #ffffff;
  border-color: #f59e0b;
}
    @media(max-width:720px){
      header h1{font-size:18px;}
      main{display:block;}
      .sidebar-toggle{display:none;}
      table{font-size:13px;}
      th,td{padding:6px 4px;}
    }
/* ã‚³ãƒ”ãƒ¼å®Œäº†ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆæ°´è‰²ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰ */
.toast-copy {
  position: fixed;
  top: 16px;
  right: 16px;
  background: #38bdf8;     /* â† æ°´è‰²ã«å¤‰æ›´ï¼ˆSky-400ï¼‰ */
  color: #0c4a6e;          /* â† ãƒ†ã‚­ã‚¹ãƒˆæ¿ƒã„é’ */
  padding: 8px 14px;
  border-radius: 999px;
  font-size: 12px;
  box-shadow: 0 10px 30px rgba(56,189,248,0.45);
  opacity: 0;
  pointer-events: none;
  transform: translateY(-8px);
  transition: opacity 0.2s ease, transform 0.2s ease;
  z-index: 9999;
}
.toast-copy.show {
  opacity: 1;
  transform: translateY(0);
}
/* åœ’ãƒ»ã‚¯ãƒ©ã‚¹ãƒ»æ°åã®ç¾åœ¨é¸æŠè¡¨ç¤º */
.selection-header {
  margin-bottom: 8px;
  font-size: 13px;
  color: var(--subtext);
  display: flex;
  flex-wrap: wrap;
  gap: 4px 16px;
}
.selection-header-block {
  display: flex;
  align-items: baseline;
  gap: 4px;
}
.selection-label {
  font-weight: 600;
}
.selection-value {
  font-weight: 500;
}
.selection-value.empty {
  color: #9ca3af;   /* æœªé¸æŠã£ã½ãè–„ã */
}
.selection-value.auto {
  opacity: 0.65;    /* è‡ªå‹•ã§é¸ã°ã‚Œã¦ã„ã‚‹æ™‚ã¯å°‘ã—è–„ã */
}
/* ===== åœ’å…ã‚¢ã‚¤ã‚³ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ ===== */
.icon-picker-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.08);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1200;
}
.icon-picker {
  background: #ffffff;
  border-radius: 16px;
  padding: 8px 10px;
  box-shadow: 0 12px 30px rgba(15,23,42,0.18);
  border: 1px solid #e5e7eb;
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  max-width: 260px;
  font-size: 20px;
}
.icon-picker button {
  border: none;
  background: transparent;
  cursor: pointer;
  padding: 4px 6px;
  border-radius: 999px;
  transition: background 0.15s, transform 0.08s;
}
.icon-picker button:hover {
  background: #e0f2fe;
  transform: translateY(-1px);
}
  </style>
</head>
<body>
  <header>
    <div class="logo-circle">åœ’</div>
    <div style="flex:1;">
      <h1>æ¨™æº–ãƒ»çŸ­æ™‚é–“ åˆ‡ã‚Šæ›¿ãˆè¨ˆç®—</h1>
      <p>å»¶é•·ä¿è‚²ï¼š30åˆ†200å††ï¼ˆ3,000å††ä¸Šé™ï¼‰ï¼ ç™»åœ’ãŒæ—©ãã¦ã‚‚å»¶é•·è¨ˆç®—</p>
    </div>
    <button id="toggleSidebar" class="small secondary sidebar-toggle">ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ã¨ã˜ã‚‹</button>
  </header>
  <main>
    <div class="sidebar">
      <section class="panel">
        <h2>å…¥åŠ›</h2>
        <div class="grid two">
          <div>
            <label for="csvFile">
              ç™»é™åœ’å®Ÿç¸¾è¡¨ï¼ˆæœˆã”ã¨ãƒ»CSVï¼‰
              <span id="helpCsv" class="help-link">ï¼Ÿ</span>
            </label>
            <input id="csvFile" type="file" accept=".csv,text/csv" />
            <div style="margin-top:10px;">
              <button id="calculate" type="button">è¨ˆç®—ã™ã‚‹</button>
            </div>
          </div>
          <div>
            <label for="bufferMinutes">ãƒãƒƒãƒ•ã‚¡ï¼ˆåˆ†ï¼‰</label>
            <input id="bufferMinutes" type="number" min="0" step="1" value="0" />
            <p class="muted">
              ä¾‹: 3åˆ† â†’ ç™»åœ’7:27ãªã‚‰ 7:27-7:30 ï¼ é™åœ’18:33ãªã‚‰ 18:33-19:00 ãŒå»¶é•·å¯¾è±¡
            </p>
          </div>
        </div>
      </section>
      <section class="panel">
        <h2>å‡ºåŠ›ãƒ»è¡¨ç¤ºè¨­å®š</h2>
        <div style="margin-bottom:10px;display:flex;flex-direction:column;gap:6px;">
          <button id="download"     type="button" class="small secondary" disabled>ã‚µãƒãƒªãƒ¼Excelé¢¨</button>
          <button id="downloadPage" type="button" class="small secondary" disabled>ãƒšãƒ¼ã‚¸HTMLä¿å­˜</button>
          <button id="downloadText" type="button" class="small secondary" disabled>ãƒ†ã‚­ã‚¹ãƒˆä¿å­˜</button>
        </div>
        <details class="options">
          <summary>ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆè¡¨ç¤ºè¨­å®šï¼‰</summary>
          <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:12px;font-size:13px;">
            <label><input type="checkbox" id="hideHeaderYear" checked /> å¹´åˆ—</label>
            <label><input type="checkbox" id="hideHeaderMonth" checked /> æœˆåˆ—</label>
            <label><input type="checkbox" id="hideHeaderDay" /> æ—¥åˆ—</label>
            <label><input type="checkbox" id="hideHeaderWeekday" checked /> æ›œæ—¥åˆ—</label>
            <label><input type="checkbox" id="hideHeaderType" /> åŒºåˆ†åˆ—</label>
            <label><input type="checkbox" id="hideHeaderEnd" checked /> åŸºæº–çµ‚äº†åˆ—</label>
            <label><input type="checkbox" id="hideHeaderBuffer" checked /> ãƒãƒƒãƒ•ã‚¡åˆ—</label>
            <label><input type="checkbox" id="hideHeaderArrive" /> ç™»åœ’æ™‚åˆ»åˆ—</label>
            <label><input type="checkbox" id="hideHeaderLeave" /> é™åœ’æ™‚åˆ»åˆ—</label>
            <label><input type="checkbox" id="hideHeaderAzukari" /> é ã‹ã‚Šä¿è‚²åˆ—</label>
            <label><input type="checkbox" id="hideHeaderOver" /> å»¶é•·æ™‚é–“åˆ—</label>
            <label><input type="checkbox" id="hideHeaderExtU" checked /> å»¶é•·å›æ•°åˆ—</label>
            <label><input type="checkbox" id="hideHeaderExtF" /> å»¶é•·æ–™é‡‘åˆ—</label>
            <label><input type="checkbox" id="hideHeaderAzukarif" /> é ã‹ã‚Šæ–™é‡‘åˆ—</label>
            <label><input type="checkbox" id="hideHeaderRemark" /> å‚™è€ƒåˆ—</label>
          </div>
        </details>
      </section>
      <section class="panel">
        <h2>å¤‰æ›´å±¥æ­´</h2>
        <details id="logDetails">
          <summary>å±¥æ­´ã‚’è¡¨ç¤º</summary>
          <div id="logContainer" class="muted" style="margin-top:6px;">ã¾ã å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
        </details>
      </section>
    </div>
    <div class="content">
      <section class="panel">
        <h2>æœˆåˆ¥ãƒ»äººåˆ¥ã‚µãƒãƒªãƒ¼</h2>
        <details id="summaryDetails">
          <summary>ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º</summary>
          <div id="summaryContainer" class="muted" style="margin-top:8px;">
            CSVã‚’èª­ã¿è¾¼ã‚“ã§è¨ˆç®—ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </div>
        </details>
      </section>
      <section class="panel">
        <h2>æ—¥æ¬¡æ˜ç´°</h2>
        <div id="dateRangeLabel" class="date-range"></div>
        <div id="detailContainer" class="muted">è¨ˆç®—å¾Œã«äººã”ã¨ã®ã‚¿ãƒ–ã¨æ—¥æ¬¡æ˜ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
      </section>
    </div>
  </main>
  <!-- CSVãƒ˜ãƒ«ãƒ— -->
  <div id="helpModal" class="help-backdrop">
    <div class="help-box">
      <h3>ç™»é™åœ’å®Ÿç¸¾è¡¨ï¼ˆæœˆã”ã¨ãƒ»CSVï¼‰ã®å–å¾—æ–¹æ³•</h3>
      <p class="muted">åœ’ã®ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œç™»é™åœ’å®Ÿç¸¾è¡¨ï¼ˆæœˆã”ã¨ãƒ»CSVï¼‰ã€ã‚’é¸æŠã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
      <img src="csv-help.png" alt="ç™»é™åœ’CSVå–å¾—æ–¹æ³•" />
      <div class="help-footer">
        <button type="button" id="helpClose" class="small secondary">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  <!-- åœ’å…ã‚¢ã‚¤ã‚³ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ -->
  <div id="iconPickerBackdrop" class="icon-picker-backdrop">
    <div class="icon-picker" id="iconPicker">
      <button type="button" data-emoji="ğŸ£">ğŸ£</button>
      <button type="button" data-emoji="ğŸ»">ğŸ»</button>
      <button type="button" data-emoji="ğŸ±">ğŸ±</button>
      <button type="button" data-emoji="ğŸ§">ğŸ§</button>
      <button type="button" data-emoji="ğŸ¼">ğŸ¼</button>
      <button type="button" data-emoji="ğŸ¦Š">ğŸ¦Š</button>
      <button type="button" data-emoji="ğŸ°">ğŸ°</button>
      <button type="button" data-emoji="ğŸŒ¸">ğŸŒ¸</button>
      <button type="button" data-emoji="â­">â­</button>
      <button type="button" data-emoji="ğŸš—">ğŸš—</button>
    </div>
  </div>
  <script>
// ===== è¿½åŠ ï¼šä¿å­˜ç”¨ã®ã‚­ãƒ¼ãªã© =====
const STORAGE_VERSION = 'v2';           // [AZUKARI]
let currentFileKey    = null;
// åœ’å…ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆåœ’ + ã‚¯ãƒ©ã‚¹ + åå‰ -> çµµæ–‡å­—ï¼‰
let iconByChild = {};
    // æ™‚é–“å®šç¾©
    const START_STANDARD = 7*60+30;
    const END_STANDARD   = 18*60+30;
    const START_SHORT    = 8*60+30;
    const END_SHORT      = 16*60+30;
// â˜… 1å·èªå®šï¼ˆ8:30ã€œ16:30ï¼‰
const START_1GOU     = 8*60+30;   // 1å·èªå®š  8:30
const END_1GOU       = 16*60+30;  // 1å·èªå®š 16:30
// [AZUKARI] é ã‚Šä¿è‚²ã®å˜ä¾¡ã¨ä¸Šé™
const AZUKARI_UNIT_MINUTES      = 30;           // [AZUKARI]
const AZUKARI_DEFAULT_UNIT_FEE  = 200;          // [AZUKARI]
const AZUKARI_DEFAULT_MONTH_CAP = 0;            // 0=ä¸Šé™ãªã—  [AZUKARI]
let azukariUnitFee    = AZUKARI_DEFAULT_UNIT_FEE;   // [AZUKARI]
let azukariMonthlyCap = AZUKARI_DEFAULT_MONTH_CAP;  // [AZUKARI]
    const EXT_UNIT_FEE   = 200;
    const MONTHLY_CAP    = 3000;
    const fileInput          = document.getElementById('csvFile');
    const bufferInput        = document.getElementById('bufferMinutes');
    const calculateButton    = document.getElementById('calculate');
    const downloadButton     = document.getElementById('download');
    const downloadPageButton = document.getElementById('downloadPage');
    const downloadTextButton = document.getElementById('downloadText');
    const summaryContainer   = document.getElementById('summaryContainer');
    const detailContainer    = document.getElementById('detailContainer');
    const logContainer       = document.getElementById('logContainer');
    const dateRangeLabel     = document.getElementById('dateRangeLabel');
    const toggleSidebarBtn   = document.getElementById('toggleSidebar');
    const helpCsvBtn         = document.getElementById('helpCsv');
    const helpModal          = document.getElementById('helpModal');
    const helpClose          = document.getElementById('helpClose');
    const hideHeaderYear    = document.getElementById('hideHeaderYear');
    const hideHeaderMonth   = document.getElementById('hideHeaderMonth');
    const hideHeaderDay     = document.getElementById('hideHeaderDay');
    const hideHeaderWeekday = document.getElementById('hideHeaderWeekday');
    const hideHeaderType    = document.getElementById('hideHeaderType');
    const hideHeaderEnd     = document.getElementById('hideHeaderEnd');
    const hideHeaderBuffer  = document.getElementById('hideHeaderBuffer');
    const hideHeaderArrive  = document.getElementById('hideHeaderArrive');
    const hideHeaderLeave   = document.getElementById('hideHeaderLeave');
    const hideHeaderAzukari = document.getElementById('hideHeaderAzukari');
    const hideHeaderOver    = document.getElementById('hideHeaderOver');
    const hideHeaderExtU    = document.getElementById('hideHeaderExtU');
    const hideHeaderExtF    = document.getElementById('hideHeaderExtF');
    const hideHeaderAzukarif= document.getElementById('hideHeaderAzukarif');
    const hideHeaderRemark  = document.getElementById('hideHeaderRemark');
    const COLUMN_WIDTH_STORAGE_KEY = 'encho-tool:column-widths';
    let columnWidths = {};
    loadColumnWidthsFromStorage();
    let lastResult    = null;
    let originalRows  = [];
    let originalBuffer= 0;
    let lastDateRange = null;
    let changeLogs    = [];
    let originalStatusList = []; // â† ã‚‚ã†å…¥ã£ã¦ã‚‹ãªã‚‰ãã®ã¾ã¾ã§OK
    let originalRowsBackup = []; // â˜… è¿½åŠ ï¼šæœ€åˆã®è¡Œãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    let lastSelectedSchool = null;  // â˜… æœ€å¾Œã«é¸ã‚“ã åœ’
    let lastSelectedClass  = null;  // â˜… æœ€å¾Œã«é¸ã‚“ã ã‚¯ãƒ©ã‚¹
    // overrides: index -> { baseType?, type?, arriveMinutes?, leaveMinutes?, azukariMinutes? } // [AZUKARI]
    const overrides   = new Map();
    // index -> å…ƒã®å‡ºæ¬ ï¼ˆä¼‘åœ’ / æ¬ åœ’ / ç™»åœ’ ãªã©ï¼‰ã‚’é€€é¿ã—ã¦ãŠã
    const originalStatusBackup = new Map();
    const columns = {
    date:   'æ—¥ä»˜',
    status: 'å‡ºæ¬ ',
    name:   'åå‰',
    school: 'åœ’',       // â˜… åœ’
    clazz:  'æ‰€å±',     // â˜… ã‚¯ãƒ©ã‚¹ï¼ˆæ‰€å±ï¼‰
    arrive: 'ç™»åœ’æ™‚åˆ»',
    goout:  'å¤–å‡ºæ™‚åˆ»',
    back:   'æˆ»ã‚Šæ™‚åˆ»',
    leave:  'é™åœ’æ™‚åˆ»'
    };
// ã‚¢ã‚¤ã‚³ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ç”¨
let currentIconChildKey = null;
const iconPickerBackdrop = document.getElementById('iconPickerBackdrop');
const iconPicker         = document.getElementById('iconPicker');
// ã“ã®æ—¥ã®ã“ã®å­ã‚’ä¸€æ„ã«è¡¨ã™ã‚­ãƒ¼ï¼ˆCSV è¡Œãƒ™ãƒ¼ã‚¹ï¼‰
function makeRecordKeyFromRow(row){
  const date   = (row[columns.date]   || '').trim();
  const name   = (row[columns.name]   || '').trim();
  const school = (row[columns.school] || '').trim();
  const clazz  = (row[columns.clazz]  || '').trim();
  return [date, school, clazz, name].join('|');
}
// æ˜ç´°ï¼ˆdetail ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã‹ã‚‰ã‚­ãƒ¼ã‚’ä½œã‚‹ç‰ˆ
function makeRecordKeyFromDetail(d){
  const date   = (d.date   || '').trim();
  const name   = (d.name   || '').trim();
  const school = (d.school || '').trim();
  const clazz  = (d.clazz  || '').trim();
  return [date, school, clazz, name].join('|');
}
// ã‚¢ã‚¤ã‚³ãƒ³ç”¨ï¼ˆåœ’ + ã‚¯ãƒ©ã‚¹ + åå‰ï¼‰
function makeChildKey(school, clazz, name){
  return [school || '', clazz || '', name || ''].join('|');
}
function loadColumnWidthsFromStorage(){
  columnWidths = {};
  try{
    const raw = localStorage.getItem(COLUMN_WIDTH_STORAGE_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      if (parsed && typeof parsed === 'object') {
        columnWidths = parsed;
      }
    }
  }catch(e){
    columnWidths = {};
  }
}
function saveColumnWidthsToStorage(){
  try{
    localStorage.setItem(COLUMN_WIDTH_STORAGE_KEY, JSON.stringify(columnWidths));
  }catch(e){/* ä¿å­˜å¤±æ•—æ™‚ã¯é»™ã£ã¦ç„¡è¦– */}
}
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰
    toggleSidebarBtn.addEventListener('click',()=>{
      document.body.classList.toggle('sidebar-collapsed');
      const collapsed = document.body.classList.contains('sidebar-collapsed');
      toggleSidebarBtn.textContent = collapsed
        ? 'ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ã²ã‚‰ã'
        : 'ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’ã¨ã˜ã‚‹';
    });
    // CSVãƒ˜ãƒ«ãƒ—
    helpCsvBtn.addEventListener('click',()=>{helpModal.style.display='flex';});
    helpClose.addEventListener('click',()=>{helpModal.style.display='none';});
    helpModal.addEventListener('click',(e)=>{
      if(e.target===helpModal) helpModal.style.display='none';
    });
    // ===== åˆ—è¡¨ç¤ºãƒˆã‚°ãƒ«ï¼ˆå¹´ãƒ»æœˆãƒ»åŸºæº–çµ‚äº†ãƒ»ãƒãƒƒãƒ•ã‚¡ãƒ»å»¶é•·å›æ•°ãªã©ï¼‰ =====
    // ä¸€æ‹¬ã§åæ˜ ã™ã‚‹é–¢æ•°
    function applyColumnVisibility(){
      // ã„ã£ãŸã‚“å…¨éƒ¨ãƒªã‚»ãƒƒãƒˆ
      detailContainer.classList.remove(
        'hide-h-year',
        'hide-h-month',
        'hide-h-day',
        'hide-h-weekday',
        'hide-h-type',
        'hide-h-end',
        'hide-h-buffer',
        'hide-h-arrive',
        'hide-h-leave',
        'hide-h-azukari',
        'hide-h-over',
        'hide-h-extu',
        'hide-h-extf',
        'hide-h-azukarif',
        'hide-h-remark'
      );
      // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã ã‘ä»˜ã‘ç›´ã™
      [
        [hideHeaderYear,   'hide-h-year'],
        [hideHeaderMonth,  'hide-h-month'],
        [hideHeaderDay,    'hide-h-day'],
        [hideHeaderWeekday,'hide-h-weekday'],
        [hideHeaderType,   'hide-h-type'],
        [hideHeaderEnd,    'hide-h-end'],
        [hideHeaderBuffer, 'hide-h-buffer'],
        [hideHeaderArrive, 'hide-h-arrive'],
        [hideHeaderLeave,  'hide-h-leave'],
        [hideHeaderAzukari,'hide-h-azukari'],
        [hideHeaderOver,   'hide-h-over'],
        [hideHeaderExtU,   'hide-h-extu'],
        [hideHeaderExtF,   'hide-h-extf'],
        [hideHeaderAzukarif,'hide-h-azukarif'],
        [hideHeaderRemark, 'hide-h-remark']   // â˜… å‚™è€ƒã‚‚ã“ã“ã§åˆ¶å¾¡
      ].forEach(([cb, cls])=>{
        if (!cb) return;
        if (cb.checked) {
          detailContainer.classList.add(cls);
        }
      });
    }
    // åˆæœŸçŠ¶æ…‹ï¼ˆå¹´ãƒ»æœˆãƒ»åŸºæº–çµ‚äº†ãƒ»ãƒãƒƒãƒ•ã‚¡ãƒ»å»¶é•·å›æ•°ã¯éè¡¨ç¤ºï¼‰
    hideHeaderYear.checked   = true;
    hideHeaderMonth.checked  = true;
    hideHeaderEnd.checked    = true;
    hideHeaderBuffer.checked = true;
    hideHeaderExtU.checked   = true;
    // å‚™è€ƒã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤ºã«ã—ãŸã‘ã‚Œã° checked = false ã®ã¾ã¾
    applyColumnVisibility();
    // ãƒã‚§ãƒƒã‚¯ãŒå¤‰ã‚ã£ãŸã‚‰æ¯å›å†é©ç”¨
    [
      hideHeaderYear,
      hideHeaderMonth,
      hideHeaderDay,
      hideHeaderWeekday,
      hideHeaderType,
      hideHeaderEnd,
      hideHeaderBuffer,
      hideHeaderArrive,
      hideHeaderLeave,
      hideHeaderAzukari,
      hideHeaderOver,
      hideHeaderExtU,
      hideHeaderExtF,
      hideHeaderAzukarif,
      hideHeaderRemark
    ].forEach(cb=>{
      if (!cb) return;
      cb.addEventListener('change', applyColumnVisibility);
    });
    const columnToggleConfig = [
      { label: 'å¹´åˆ—', checkbox: hideHeaderYear },
      { label: 'æœˆåˆ—', checkbox: hideHeaderMonth },
      { label: 'æ—¥åˆ—', checkbox: hideHeaderDay },
      { label: 'æ›œæ—¥åˆ—', checkbox: hideHeaderWeekday },
      { label: 'åŒºåˆ†åˆ—', checkbox: hideHeaderType },
      { label: 'åŸºæº–çµ‚äº†åˆ—', checkbox: hideHeaderEnd },
      { label: 'ãƒãƒƒãƒ•ã‚¡åˆ—', checkbox: hideHeaderBuffer },
      { label: 'ç™»åœ’æ™‚åˆ»åˆ—', checkbox: hideHeaderArrive },
      { label: 'é™åœ’æ™‚åˆ»åˆ—', checkbox: hideHeaderLeave },
      { label: 'é ã‹ã‚Šä¿è‚²åˆ—', checkbox: hideHeaderAzukari },
      { label: 'å»¶é•·æ™‚é–“åˆ—', checkbox: hideHeaderOver },
      { label: 'å»¶é•·å›æ•°åˆ—', checkbox: hideHeaderExtU },
      { label: 'å»¶é•·æ–™é‡‘åˆ—', checkbox: hideHeaderExtF },
      { label: 'é ã‹ã‚Šæ–™é‡‘åˆ—', checkbox: hideHeaderAzukarif },
      { label: 'å‚™è€ƒåˆ—', checkbox: hideHeaderRemark }
    ];
    const LONG_PRESS_DURATION = 600;
    let columnMenuBackdrop = null;
    let columnMenuListEl = null;
    function ensureColumnMenu(){
      if (columnMenuBackdrop) return;
      columnMenuBackdrop = document.createElement('div');
      columnMenuBackdrop.className = 'column-menu-backdrop';
      const menu = document.createElement('div');
      menu.className = 'column-menu';
      menu.innerHTML = ''
        + '<div class="column-menu-header">'
        +   '<span>åˆ—ã®è¡¨ç¤º/éè¡¨ç¤º</span>'
        +   '<button type="button" class="column-menu-close" aria-label="é–‰ã˜ã‚‹">Ã—</button>'
        + '</div>'
        + '<div class="column-menu-list"></div>';
      columnMenuListEl = menu.querySelector('.column-menu-list');
      columnMenuBackdrop.appendChild(menu);
      document.body.appendChild(columnMenuBackdrop);
      columnMenuBackdrop.addEventListener('click',(e)=>{
        if (e.target === columnMenuBackdrop) {
          closeColumnMenu();
        }
      });
      const closeBtn = menu.querySelector('.column-menu-close');
      if (closeBtn) closeBtn.addEventListener('click', closeColumnMenu);
    }
    function renderColumnMenu(){
      ensureColumnMenu();
      if (!columnMenuListEl) return;
      columnMenuListEl.innerHTML = '';
      columnToggleConfig.forEach(item=>{
        if (!item.checkbox) return;
        const label = document.createElement('label');
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = item.checkbox.checked;
        input.addEventListener('change',()=>{
          item.checkbox.checked = input.checked;
          applyColumnVisibility();
        });
        label.appendChild(input);
        const text = document.createElement('span');
        text.textContent = item.label;
        label.appendChild(text);
        columnMenuListEl.appendChild(label);
      });
    }
    function openColumnMenu(){
      renderColumnMenu();
      if (columnMenuBackdrop) {
        columnMenuBackdrop.classList.add('open');
      }
    }
    function closeColumnMenu(){
      if (columnMenuBackdrop) {
        columnMenuBackdrop.classList.remove('open');
      }
    }
    function attachLongPressToHeaders(root){
      const headers = root.querySelectorAll('th');
      headers.forEach(th=>{
        let timer = null;
        const clear = ()=>{
          if (timer) {
            clearTimeout(timer);
            timer = null;
          }
        };
        th.addEventListener('pointerdown',(e)=>{
          if (e.target.closest('.column-resizer')) return;
          clear();
          timer = setTimeout(()=>{
            openColumnMenu();
          }, LONG_PRESS_DURATION);
        });
        ['pointerup','pointerleave','pointercancel'].forEach(ev=>{
          th.addEventListener(ev, clear);
        });
      });
    }
    function getColumnKeyFromHeader(th, index){
      const colClass = Array.from(th.classList).find(c=>c.startsWith('col-'));
      if (colClass) return colClass;
      const textKey = (th.textContent || '').trim().replace(/\s+/g,'_');
      if (textKey) return 'text-' + textKey;
      return 'index-' + index;
    }
    function syncColumnWidth(table, index, width){
      const w = Math.max(60, width);
      const headCells = table.querySelectorAll(`th:nth-child(${index+1})`);
      headCells.forEach(cell=>{
        cell.style.width = w + 'px';
        cell.style.minWidth = w + 'px';
      });
      const bodyCells = table.querySelectorAll(`tbody tr td:nth-child(${index+1})`);
      bodyCells.forEach(cell=>{
        cell.style.width = w + 'px';
        cell.style.minWidth = w + 'px';
      });
    }
    function applyStoredWidthsToTable(table){
      const headers = table.querySelectorAll('th');
      headers.forEach((th, index)=>{
        const key = getColumnKeyFromHeader(th, index);
        if (key && columnWidths[key]) {
          syncColumnWidth(table, index, columnWidths[key]);
        }
      });
    }
    function makeTableResizable(table){
      applyStoredWidthsToTable(table);
      const headers = table.querySelectorAll('th');
      headers.forEach((th, index)=>{
        th.classList.add('resizable-header');
        const handle = document.createElement('span');
        handle.className = 'column-resizer';
        handle.title = 'ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åˆ—å¹…ã‚’å¤‰æ›´';
        th.appendChild(handle);
        handle.addEventListener('pointerdown',(e)=>{
          e.preventDefault();
          e.stopPropagation();
          const startX = e.clientX;
          const startWidth = th.offsetWidth;
          const onMove = (ev)=>{
            const delta = ev.clientX - startX;
            syncColumnWidth(table, index, startWidth + delta);
          };
          const onUp = ()=>{
            const width = th.offsetWidth;
            const key = getColumnKeyFromHeader(th, index);
            if (key) {
              columnWidths[key] = width;
              saveColumnWidthsToStorage();
            }
            window.removeEventListener('pointermove', onMove);
            window.removeEventListener('pointerup', onUp);
            window.removeEventListener('pointercancel', onUp);
          };
          window.addEventListener('pointermove', onMove);
          window.addEventListener('pointerup', onUp);
          window.addEventListener('pointercancel', onUp);
        });
      });
    }
    function setupResizableTables(root){
      const tables = root.querySelectorAll('table');
      tables.forEach(table=>makeTableResizable(table));
    }
    function enhanceTables(root){
      setupResizableTables(root);
      attachLongPressToHeaders(root);
    }
// ã€Œè¨ˆç®—ã™ã‚‹ã€ãƒœã‚¿ãƒ³
calculateButton.addEventListener('click', () => {
  const file = (fileInput.files && fileInput.files[0]) || null;
  const bufferMinutes = Number(bufferInput.value || 0);
  if (!file) {
    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  if (Number.isNaN(bufferMinutes) || bufferMinutes < 0) {
    alert('ãƒãƒƒãƒ•ã‚¡ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    return;
  }
  // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
  overrides.clear();
  changeLogs = [];
  renderLogs();
  const reader = new FileReader();
  // â˜… ã“ã“ã§èª­ã¿è¾¼ã¿å®Œäº†å¾Œã®å‡¦ç†ã‚’ã™ã‚‹
  reader.onload = () => {
    try {
      const text = String(reader.result || '');
      const rows = parseCSV(text);
      // â˜… ä¿å­˜ã—ã¦ã‚ã£ãŸå¤‰æ›´ï¼ˆåŒºåˆ†ãƒ»æ™‚åˆ»ãƒ»ã‚¿ãƒ–ï¼‰ã‚’å¾©å…ƒ
      loadStateFromStorage(rows);
      originalRows        = rows;
      originalRowsBackup  = rows.map(r => ({ ...r }));        // å…ƒãƒ‡ãƒ¼ã‚¿é€€é¿
      originalBuffer      = bufferMinutes;
      originalStatusList  = rows.map(row => (row[columns.status] || '').trim());
      // è¨ˆç®—ã—ã¦è¡¨ç¤º
      const result = calculate(rows, bufferMinutes);
      lastResult   = result;
      renderSummary(result.summary);
      renderDetails(result.details);
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç³»ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      downloadButton.disabled     = false;
      downloadPageButton.disabled = false;
      downloadTextButton.disabled = false;
    } catch (e) {
      console.error(e);
      alert('CSVã®èª­ã¿è¾¼ã¿ã¾ãŸã¯è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
    }
  };
  // å®Ÿéš›ã«èª­ã¿è¾¼ã¿é–‹å§‹
  reader.readAsText(file);
});
// ===== å¤‰æ›´å†…å®¹ãƒ»ã‚¿ãƒ–é¸æŠãƒ»ã‚¢ã‚¤ã‚³ãƒ³ã‚’ localStorage ã«ä¿å­˜ =====
function saveStateToStorage(){
  if (!lastResult || !originalRows.length || !currentFileKey) return;
  const data = {
    version: STORAGE_VERSION,
    azukariUnitFee,
    azukariMonthlyCap,
    lastSelectedSchool,
    lastSelectedClass,
    iconByChild,
    overrides: {}
  };
  // overridesï¼ˆè¡Œã”ã¨ã®å¤‰æ›´ï¼‰ã‚’æ—¥ä»˜+åœ’+ã‚¯ãƒ©ã‚¹+åå‰ã§ä¿å­˜
  lastResult.details.forEach(d=>{
    const o = overrides.get(d.recordIndex);
    if (!o) return;
    const key = makeRecordKeyFromDetail(d);
    data.overrides[key] = {
      baseType:      o.baseType      ?? null,
      type:          o.type          ?? null,
      arriveMinutes: o.arriveMinutes ?? null,
      leaveMinutes:  o.leaveMinutes  ?? null,
      azukariMinutes:o.azukariMinutes?? null  // [AZUKARI]
    };
  });
  try{
    localStorage.setItem(currentFileKey, JSON.stringify(data));
  }catch(e){
    console.warn('çŠ¶æ…‹ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', e);
  }
}
// ===== localStorage ã‹ã‚‰å¾©å…ƒ =====
function loadStateFromStorage(rows){
  const file = fileInput.files && fileInput.files[0];
  const fileName = file ? file.name : 'default.csv';
  currentFileKey = 'encho-tool:' + STORAGE_VERSION + ':' + fileName;
  const raw = localStorage.getItem(currentFileKey);
  if (!raw) return;
  try{
    const data = JSON.parse(raw);
    overrides.clear();
    lastSelectedSchool = data.lastSelectedSchool || null;
    lastSelectedClass  = data.lastSelectedClass  || null;
    iconByChild        = data.iconByChild || {};
    azukariUnitFee     = data.azukariUnitFee != null ? Number(data.azukariUnitFee) : AZUKARI_DEFAULT_UNIT_FEE;       // [AZUKARI]
    azukariMonthlyCap  = data.azukariMonthlyCap != null ? Number(data.azukariMonthlyCap) : AZUKARI_DEFAULT_MONTH_CAP; // [AZUKARI]
    if (Number.isNaN(azukariUnitFee))    azukariUnitFee    = AZUKARI_DEFAULT_UNIT_FEE;       // [AZUKARI]
    if (Number.isNaN(azukariMonthlyCap)) azukariMonthlyCap = AZUKARI_DEFAULT_MONTH_CAP;      // [AZUKARI]
    const savedOverrides = data.overrides || {};
    rows.forEach((row, index)=>{
      const key = makeRecordKeyFromRow(row);
      const o   = savedOverrides[key];
      if (!o) return;
      const base = {};
      if (o.baseType)                base.baseType      = o.baseType;
      if (o.type)                    base.type          = o.type;
      if (o.arriveMinutes != null)   base.arriveMinutes = o.arriveMinutes;
      if (o.leaveMinutes  != null)   base.leaveMinutes  = o.leaveMinutes;
      if (o.azukariMinutes!= null)   base.azukariMinutes= o.azukariMinutes; // [AZUKARI]
      if (Object.keys(base).length)  overrides.set(index, base);
    });
  }catch(e){
    console.warn('çŠ¶æ…‹å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ', e);
  }
}
// ===== CSVãƒ‘ãƒ¼ã‚¹ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’è‡ªå‹•æ¤œå‡ºï¼‰ =====
function parseCSV(text){
  const linesRaw = [];
  let cur = '';
  let row = [];
  let inside = false;
  // æ–‡å­—å˜ä½ã§CSVã‚’ãƒ‘ãƒ¼ã‚¹
  for (let i = 0; i < text.length; i++) {
    const ch   = text[i];
    const next = text[i + 1];
    if (ch === '"') {
      if (inside && next === '"') { cur += '"'; i++; continue; }
      inside = !inside;
      continue;
    }
    if (ch === ',' && !inside) {
      row.push(cur);
      cur = '';
      continue;
    }
    if ((ch === '\n' || ch === '\r') && !inside) {
      if (ch === '\r' && next === '\n') i++;
      row.push(cur);
      linesRaw.push(row);
      row = [];
      cur = '';
      continue;
    }
    cur += ch;
  }
  if (cur || row.length) {
    row.push(cur);
    linesRaw.push(row);
  }
  if (!linesRaw.length) return [];
  // â˜… ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ¢ã™ï¼ˆã€Œæ—¥ä»˜ã€ã€Œå‡ºæ¬ ã€ã€Œåå‰ã€ãŒå«ã¾ã‚Œã‚‹è¡Œï¼‰
  let headerIndex = 0;
  for (let i = 0; i < linesRaw.length; i++) {
    const joined = linesRaw[i].join('');
    if (joined.includes('æ—¥ä»˜') && joined.includes('å‡ºæ¬ ') && joined.includes('åå‰')) {
      headerIndex = i;
      break;
    }
  }
  let header = linesRaw[headerIndex];
  // â˜… ãƒ˜ãƒƒãƒ€ãƒ¼ãŒ 1ã‚»ãƒ«ã«å…¨éƒ¨å…¥ã£ã¦ã„ã‚‹ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šï¼‰ã®å ´åˆã«åˆ†è§£
  if (header.length === 1 && header[0].includes('æ—¥ä»˜') && header[0].includes('å‡ºæ¬ ')) {
    header = header[0].trim().split(/\s+/);
  }
  // â˜… BOM å¯¾ç­–ï¼ˆå…ˆé ­ã« \uFEFF ãŒä»˜ã„ã¦ã„ãŸã‚‰å‰Šã‚‹ï¼‰
  if (header[0] && header[0].charCodeAt(0) === 0xFEFF) {
    header[0] = header[0].slice(1);
  }
  const records = [];
  for (let i = headerIndex + 1; i < linesRaw.length; i++) {
    const line = linesRaw[i];
    // å®Œå…¨ç©ºè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
    if (line.length === 1 && line[0].trim() === '') continue;
    const obj = {};
    for (let c = 0; c < header.length; c++) {
      const key = (header[c] || '').trim();
      if (!key) continue;
      obj[key] = line[c] != null ? line[c] : '';
    }
    records.push(obj);
  }
  return records;
}
// ===== é›†è¨ˆ =====
function calculate(rows, bufferMinutes){
  const summaryMap = new Map();
  const details    = [];
  const capValue   = azukariMonthlyCap>0 ? azukariMonthlyCap : Infinity; // [AZUKARI]
  let minKey = null, maxKey = null;
  rows.forEach((row,index)=>{
    const status = (row[columns.status]||'').trim();
    const isVacation = /é•·æœŸ|é•·ä¼‘|å¤ä¼‘ã¿|å†¬ä¼‘ã¿|æ˜¥ä¼‘ã¿|é€£ä¼‘|ä¼‘æš‡/.test(status); // [VACATION]
    let attendLabel = 'ä¼‘åœ’';
    if (isVacation) {
      attendLabel = 'é•·æœŸä¼‘æš‡'; // [VACATION]
    } else if (status && /æ¬ /.test(status)) {
      attendLabel = 'æ¬ åœ’';
    } else if (status && /ç™»|å‡º|â—‹/.test(status)) {
      attendLabel = 'ç™»åœ’';
    }
    const rawDate = (row[columns.date]||'').trim();
    if(!rawDate) return;
    const {year,month,day} = splitYMD(rawDate);
    if(!year||!month||!day) return;
    const dateKey = Number(year)*10000+Number(month)*100+Number(day);
    if(minKey==null||dateKey<minKey) minKey=dateKey;
    if(maxKey==null||dateKey>maxKey) maxKey=dateKey;
    const arriveStr = (row[columns.arrive]||'').trim();
    const leaveStr  = (row[columns.leave] ||'').trim();
    const baseArrive = parseTimeToMinutes(arriveStr);
    const baseLeave  = parseTimeToMinutes(leaveStr);
    // â˜… åå‰ãƒ»åœ’ãƒ»ã‚¯ãƒ©ã‚¹
    const rawName = (row[columns.name]||'').trim() || `ä¸æ˜(${index})`;
    const school  = (row[columns.school]||'').trim() || 'åœ’æœªè¨­å®š';
    const clazz   = (row[columns.clazz] ||'').trim() || 'ã‚¯ãƒ©ã‚¹æœªè¨­å®š';
    const name    = rawName; // ã‚¿ãƒ–ã«å‡ºã™åå‰
    const oRow = overrides.get(index) || {};
    const baseTypeFromOverride = oRow.baseType || detectType(name);
    const rowTypeOverride      = oRow.type || null;
    const typeKey = rowTypeOverride || baseTypeFromOverride; // 'standard' / 'short' / '1gou'
    // â˜… åŒºåˆ†ã”ã¨ã®åŸºæº–æ™‚é–“
    let baseStart, baseEnd;
    if (typeKey === 'short') {
      baseStart = START_SHORT;
      baseEnd   = END_SHORT;
    } else if (typeKey === '1gou') {
      baseStart = START_1GOU;
      baseEnd   = END_1GOU;
    } else {
      baseStart = START_STANDARD;
      baseEnd   = END_STANDARD;
    }
    const effArrive = oRow.arriveMinutes!=null ? oRow.arriveMinutes : baseArrive;
    const effLeave  = oRow.leaveMinutes !=null ? oRow.leaveMinutes  : baseLeave;
    const weekday   = getWeekdayLabel(rawDate);
    const zeroPair = (effArrive === 0 && effLeave === 0);
    let extMinutes = 0;
    if(!zeroPair && !isVacation){ // [VACATION]
      if(effArrive!=null){
        const tStart = baseStart - bufferMinutes;
        if(effArrive<tStart) extMinutes += (tStart-effArrive);
      }
      if(effLeave!=null){
        const tEnd = baseEnd + bufferMinutes;
        if(effLeave>tEnd) extMinutes += (effLeave-tEnd);
      }
    }
    const extUnits = extMinutes>0 ? Math.ceil(extMinutes/30) : 0;
    // [AZUKARI] é ã‚Šä¿è‚²ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰
    const azOverride    = Math.max(0, oRow.azukariMinutes || 0); // [AZUKARI]
    const azukariMinutes= isVacation ? 0 : azOverride;           // [AZUKARI]
    const azukariUnits  = azukariMinutes>0                        // [AZUKARI]
      ? Math.ceil(azukariMinutes / AZUKARI_UNIT_MINUTES)         // [AZUKARI]
      : 0;                                                       // [AZUKARI]
    const azukariFeeRaw = azukariUnits * azukariUnitFee;         // [AZUKARI]
    const monthKey = `${year}-${month}`;
    const key = `${rawName}__${school}__${monthKey}`;
    if(!summaryMap.has(key)){
      summaryMap.set(key,{
        name,
        month: monthKey,
        extStdUnits: 0,   // æ¨™æº–ï¼‹1å·èªå®šã¯ã“ã¡ã‚‰
        extShortUnits: 0,  // çŸ­æ™‚é–“ã¯ã“ã¡ã‚‰
        azukariUnits: 0,   // [AZUKARI]
        azukariMinutes:0,  // [AZUKARI]
        azukariRawFee: 0,  // [AZUKARI]
        detailRefs: []     // [AZUKARI]
      });
    }
    const entry = summaryMap.get(key);
    const bucket = (typeKey === 'short') ? 'short' : 'standard';
    if (bucket === 'short') entry.extShortUnits += extUnits;
    else                    entry.extStdUnits   += extUnits;
    entry.azukariUnits   += azukariUnits;      // [AZUKARI]
    entry.azukariMinutes += azukariMinutes;    // [AZUKARI]
    entry.azukariRawFee  += azukariFeeRaw;     // [AZUKARI]
    const baseArriveForDiff = (baseArrive === 0 ? null : baseArrive);
    const baseLeaveForDiff  = (baseLeave  === 0 ? null : baseLeave);
    const deltaArrive =
      (effArrive!=null && baseArriveForDiff!=null)
        ? effArrive - baseArriveForDiff
        : 0;
    const deltaLeave  =
      (effLeave!=null && baseLeaveForDiff!=null)
        ? effLeave - baseLeaveForDiff
        : 0;
    const detail = buildDetail({
      index,name,rawDate,year,month,day,dateKey,
      typeKey,baseEnd,bufferMinutes,
      arriveMin:effArrive,leaveMin:effLeave,
      baseArrive: baseArriveForDiff,
      baseLeave:  baseLeaveForDiff,
      deltaArrive,deltaLeave,
      extMinutes,extUnits,
      weekday,
      attendLabel,
      isVacation,        // [VACATION]
      azukariMinutes,    // [AZUKARI]
      azukariUnits,      // [AZUKARI]
      azukariFeeRaw,     // [AZUKARI]
      school,
      clazz
    });
    entry.detailRefs.push(detail); // [AZUKARI]
    details.push(detail);
  });
  const summary = Array.from(summaryMap.values())
    .map(item=>{
      const extTotal = item.extStdUnits + item.extShortUnits;
      const extRaw   = extTotal * EXT_UNIT_FEE;
      const extFee   = Math.min(extRaw, MONTHLY_CAP);
      const azRaw    = item.azukariRawFee || 0;                 // [AZUKARI]
      const azFee    = Math.min(azRaw, capValue);               // [AZUKARI]
      const detailRefs = item.detailRefs || [];                 // [AZUKARI]
      if (detailRefs.length) {                                  // [AZUKARI]
        let remaining = capValue;                               // [AZUKARI]
        detailRefs.sort((a,b)=>a.dateKey-b.dateKey);            // [AZUKARI]
        detailRefs.forEach(d=>{                                 // [AZUKARI]
          const rawFee = d.azukariFeeRaw || 0;                  // [AZUKARI]
          const applied = Math.min(rawFee, remaining);          // [AZUKARI]
          d.azukariFee = applied;                               // [AZUKARI]
          d.totalFee   = d.extFee + applied;                    // [AZUKARI]
          remaining    = Math.max(0, remaining - applied);      // [AZUKARI]
        });                                                     // [AZUKARI]
      }                                                         // [AZUKARI]
      const {detailRefs: _drop, ...rest} = item;                // [AZUKARI]
      return{
        ...rest,                                                // [AZUKARI]
        extUnitsTotal: extTotal,
        extRawFee:     extRaw,
        extFee,
        azukariRawFee: azRaw,                                // [AZUKARI]
        azukariFee:    azFee,                                   // [AZUKARI]
        azukariUnitsTotal: item.azukariUnits || 0,              // [AZUKARI]
        azukariMinutesTotal:item.azukariMinutes || 0,           // [AZUKARI]
        totalFee:      extFee + azFee,                          // [AZUKARI]
        capped:   extFee<extRaw,
        switched: item.extStdUnits>0 && item.extShortUnits>0
      };
    })
    .sort((a,b)=>
      a.name.localeCompare(b.name,'ja') || a.month.localeCompare(b.month)
    );
  details.sort((a,b)=>{
    if(a.name!==b.name)   return a.name.localeCompare(b.name,'ja');
    if(a.dateKey!==b.dateKey) return a.dateKey-b.dateKey;
    return a.typeKey.localeCompare(b.typeKey);
  });
  if(minKey!=null && maxKey!=null){
    const sY=Math.floor(minKey/10000);
    const sM=Math.floor((minKey%10000)/100);
    const sD=minKey%100;
    const eY=Math.floor(maxKey/10000);
    const eM=Math.floor((maxKey%10000)/100);
    const eD=maxKey%100;
    lastDateRange={start:{y:sY,m:sM,d:sD},end:{y:eY,m:eM,d:eD}};
  }else{
    lastDateRange=null;
  }
  return {summary,details};
}
function buildDetail({
  index,name,rawDate,year,month,day,dateKey,
  typeKey,baseEnd,bufferMinutes,
  arriveMin,leaveMin,
  baseArrive,baseLeave,
  deltaArrive,deltaLeave,
  extMinutes,extUnits,
  weekday,
  attendLabel,
  isVacation,        // [VACATION]
  azukariMinutes,    // [AZUKARI]
  azukariUnits,      // [AZUKARI]
  azukariFeeRaw,     // [AZUKARI]
  school,
  clazz
}){
  const extFee=extUnits*EXT_UNIT_FEE;
  return{
    recordIndex:index,
    name,
    school,       // åœ’
    clazz,        // ã‚¯ãƒ©ã‚¹
    date:rawDate,
    year:String(year),
    month:String(month).padStart(2,'0'),
    day:String(day).padStart(2,'0'),
    dateKey,
    weekday,
    attendLabel,
    typeKey,
    type:(()=>{
      const map = {
        standard:'æ¨™æº–æ™‚é–“',
        short:'çŸ­æ™‚é–“',
        '1gou':'1å·èªå®š'
      };
      return map[typeKey] || 'æ¨™æº–æ™‚é–“';
    })(),
    baseEnd:minutesToTime(baseEnd),
    buffer:bufferMinutes+'åˆ†',
    arrive:arriveMin!=null?minutesToTime(arriveMin):'',
    leave: leaveMin !=null?minutesToTime(leaveMin) :'',
    baseArrive,
    baseLeave,
    deltaArrive,
    deltaLeave,
    extMinutes,
    extUnits,
    isVacation: !!isVacation,               // [VACATION]
    azukariMinutes: azukariMinutes||0,      // [AZUKARI]
    azukariUnits: azukariUnits||0,          // [AZUKARI]
    azukariFeeRaw: azukariFeeRaw||0,        // [AZUKARI]
    azukariFee: azukariFeeRaw||0,           // [AZUKARI]
    extFee,
    totalFee:extFee
  };
}
    // ã‚³ãƒ”ãƒ¼å®Œäº†ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showCopyToast(message){
      let t = document.querySelector('.toast-copy');
      if (!t) {
        t = document.createElement('div');
        t.className = 'toast-copy';
        document.body.appendChild(t);
      }
      t.textContent = message || 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ';
      // è¡¨ç¤º
      t.classList.add('show');
      // 1.5ç§’å¾Œã«ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
      setTimeout(()=>{
        t.classList.remove('show');
      }, 1500);
    }
// ã‚¢ã‚¤ã‚³ãƒ³ãƒ”ãƒƒã‚«ãƒ¼ã®ãƒœã‚¿ãƒ³å‡¦ç†
if (iconPicker && iconPickerBackdrop) {
  // ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ã
  iconPicker.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-emoji]');
    if (!btn || !currentIconChildKey) return;
    const emoji = btn.getAttribute('data-emoji') || 'ğŸ£';
    iconByChild[currentIconChildKey] = emoji;
    saveStateToStorage();       // ä¿å­˜
    iconPickerBackdrop.style.display = 'none';
    currentIconChildKey = null;
    if (lastResult) {
      renderDetails(lastResult.details); // å†æç”»ã—ã¦ã‚¿ãƒ–ã®ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
    }
  });
  // ãƒãƒƒã‚¯ãƒ‰ãƒ­ãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
  iconPickerBackdrop.addEventListener('click',(e)=>{
    if (e.target === iconPickerBackdrop) {
      iconPickerBackdrop.style.display = 'none';
      currentIconChildKey = null;
    }
  });
}
    function renderSummary(summary){
      if(!summary.length){
        summaryContainer.innerHTML='<p class="muted">èª²é‡‘å¯¾è±¡ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        return;
      }
      const rows=summary.map(item=>{
        const notes=[];
        if(item.switched)notes.push('åŒºåˆ†å¤‰æ›´ã‚ã‚Š');
        if(item.extFee<item.extRawFee)notes.push('å»¶é•·ä¿è‚²ä¸Šé™3,000å††é©ç”¨');
        if(item.azukariFee>0){
          const rawAz = item.azukariRawFee || 0; // [AZUKARI]
          if (rawAz>item.azukariFee) notes.push('é ã‚Šä¿è‚²ä¸Šé™é©ç”¨'); // [AZUKARI]
          notes.push(`é ã‚Šä¿è‚²ï¼š${item.azukariUnitsTotal||0}å˜ä½/${item.azukariFee.toLocaleString()}å††`); // [AZUKARI]
        }
        const noteText=notes.join('ï¼');
        const extText=item.extUnitsTotal
          ?`${item.extFee.toLocaleString()}å††ï¼ˆ200å††Ã—${item.extUnitsTotal}å›ï¼ä¸Šé™3,000å††ï¼‰`
          :'0å††';
        const totalText=item.totalFee.toLocaleString()+'å††';
        return(
          '<tr>'+
            '<td>'+escapeHtml(item.name)+'</td>'+
            '<td>'+item.month+'</td>'+
            '<td>'+item.extStdUnits+'</td>'+
            '<td>'+item.extShortUnits+'</td>'+
            '<td>'+item.extUnitsTotal+'</td>'+
            '<td>'+extText+'</td>'+
            '<td>'+totalText+'</td>'+
            '<td>'+escapeHtml(noteText)+'</td>'+
          '</tr>'
        );
      }).join('');
      summaryContainer.innerHTML=
        '<div class="chip">å»¶é•·ä¿è‚²ï¼š30åˆ†200å††ï¼ˆ3,000å††ä¸Šé™ï¼‰</div>'+
        '<table>'+
          '<caption>äººåˆ¥ãƒ»æœˆåˆ¥é›†è¨ˆ</caption>'+
          '<thead><tr>'+
            '<th>åå‰</th><th>æœˆ</th><th>æ¨™æº–å»¶é•·å›æ•°</th><th>çŸ­æ™‚é–“å»¶é•·å›æ•°</th><th>åˆè¨ˆå›æ•°</th><th>å»¶é•·ä¿è‚²æ–™é‡‘</th><th>åˆè¨ˆæ–™é‡‘</th><th>å‚™è€ƒ</th>'+
          '</tr></thead>'+
          '<tbody>'+rows+'</tbody>'+
          '</table>';
      enhanceTables(summaryContainer);
    }
// ===== æ—¥æ¬¡æ˜ç´°ã®æç”»ï¼ˆåœ’â†’ã‚¯ãƒ©ã‚¹â†’æ°åã‚¿ãƒ– + ï¼‹5/-5 & åŒºåˆ†ãƒœã‚¿ãƒ³ï¼‰ =====
function renderDetails(details){
  if(!details.length){
    detailContainer.innerHTML='<p class="muted">å»¶é•·ç™ºç”Ÿã®æ˜ç´°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    dateRangeLabel.textContent='';
    return;
  }
  // æ—¥ä»˜ãƒ¬ãƒ³ã‚¸è¡¨ç¤º
  if(lastDateRange){
    const s=lastDateRange.start,e=lastDateRange.end;
    dateRangeLabel.textContent=`ã€${s.y}/${s.m}/${s.d} ï½ ${e.y}/${e.m}/${e.d}ã€‘`;
  }else{
    dateRangeLabel.textContent='';
  }
  // ===== 1) åœ’ãƒ»ã‚¯ãƒ©ã‚¹ãƒ»æ°åã®çµã‚Šè¾¼ã¿ =====
  const schools = Array.from(
    new Set(details.map(d => d.school || 'åœ’æœªè¨­å®š'))
  ).sort((a,b)=>a.localeCompare(b,'ja'));
  if (!schools.length) {
    detailContainer.innerHTML='<p class="muted">åœ’ã®æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    return;
  }
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åœ’æ±ºå®š
  if (!lastSelectedSchool || !schools.includes(lastSelectedSchool)) {
    lastSelectedSchool = schools[0];
  }
  const activeSchool = lastSelectedSchool;
  // åœ’ã§çµã‚‹
  const detailsInSchool = details.filter(
    d => (d.school || 'åœ’æœªè¨­å®š') === activeSchool
  );
  // ã‚¯ãƒ©ã‚¹ä¸€è¦§
  const classes = Array.from(
    new Set(detailsInSchool.map(d => d.clazz || 'ã‚¯ãƒ©ã‚¹æœªè¨­å®š'))
  ).sort((a,b)=>a.localeCompare(b,'ja'));
  if (!classes.length) {
    detailContainer.innerHTML='<p class="muted">ã‚¯ãƒ©ã‚¹ã®æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    return;
  }
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¯ãƒ©ã‚¹æ±ºå®š
  if (!lastSelectedClass || !classes.includes(lastSelectedClass)) {
    lastSelectedClass = classes[0];
  }
  const activeClass = lastSelectedClass;
  // åœ’ï¼‹ã‚¯ãƒ©ã‚¹ã§çµã‚‹
  const filtered = detailsInSchool.filter(
    d => (d.clazz || 'ã‚¯ãƒ©ã‚¹æœªè¨­å®š') === activeClass
  );
  // ===== 2) ä¸Šéƒ¨é¸æŠã‚¨ãƒªã‚¢ï¼ˆåœ’ / ã‚¯ãƒ©ã‚¹ / æ°åï¼‰ =====
  // æ°åã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—
  const byName = new Map();
  filtered.forEach(d => {
    if (!byName.has(d.name)) byName.set(d.name, []);
    byName.get(d.name).push(d);
  });
  if (!byName.size) {
    detailContainer.innerHTML =
      '<p class="muted">ã“ã®åœ’ãƒ»ã‚¯ãƒ©ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    return;
  }
  const names = Array.from(byName.keys())
    .sort((a,b)=>a.localeCompare(b,'ja'));
  let activeIndex = 0; // ã¨ã‚Šã‚ãˆãšå…ˆé ­ã®åœ’å…ã‚¿ãƒ–
  // åœ’ãƒœã‚¿ãƒ³
  let schoolButtonsHtml = '';
  schools.forEach(sc => {
    const isActive = (sc === activeSchool) ? ' active' : '';
    schoolButtonsHtml +=
      '<button type="button" class="school-tab'+isActive+'" '+
        'data-school="'+escapeHtml(sc)+'">'+
        escapeHtml(sc)+
      '</button>';
  });
  // ã‚¯ãƒ©ã‚¹ãƒœã‚¿ãƒ³
  let classButtonsHtml = '';
  classes.forEach(cl => {
    const isActive = (cl === activeClass) ? ' active' : '';
    classButtonsHtml +=
      '<button type="button" class="class-tab'+isActive+'" '+
        'data-class="'+escapeHtml(cl)+'">'+
        escapeHtml(cl)+
      '</button>';
  });
  // æ°åã‚¿ãƒ–ãƒœã‚¿ãƒ³ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ä»˜ãï¼‰
  let nameButtonsHtml = '';
  names.forEach((name, idx)=>{
    const childKey = makeChildKey(activeSchool, activeClass, name);
    const icon = iconByChild[childKey] || "ğŸ£"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³
    nameButtonsHtml +=
      '<button type="button" class="tab-button'+(idx===activeIndex?' active':'')+'" '+
        'data-tab="person-'+idx+'" '+
        'data-child-key="'+escapeHtml(childKey)+'">'+
        '<span class="child-icon" style="margin-right:6px;">'+icon+'</span>'+
        escapeHtml(name)+
      '</button>';
  });
  // â˜… ã“ã“ã§ selection-row ã‚’ä½¿ã£ãŸä¸Šéƒ¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’çµ„ã¿ç«‹ã¦ã‚‹
  const headerHtml =
    '<div class="selection-panel">'+
      '<div class="selection-row">'+
        '<div class="selection-row-label">åœ’ï¼š</div>'+
        '<div class="selection-row-value">'+schoolButtonsHtml+'</div>'+
      '</div>'+
      '<div class="selection-row">'+
        '<div class="selection-row-label">ã‚¯ãƒ©ã‚¹ï¼š</div>'+
        '<div class="selection-row-value">'+classButtonsHtml+'</div>'+
      '</div>'+
      '<div class="selection-row">'+
        '<div class="selection-row-label">æ°åï¼š</div>'+
        '<div class="selection-row-value">'+nameButtonsHtml+'</div>'+
      '</div>'+
    '</div>';
  function diffText(value){
    if(value==null || value===0) return 'Â±0åˆ†';
    const sign=value>0?'+':'-';
    return `${sign}${Math.abs(value)}åˆ†`;
  }
  // ===== 3) æ°åã”ã¨ã®ãƒ†ãƒ¼ãƒ–ãƒ« =====
  let panelsHtml='';
  names.forEach((name,idx)=>{
    const list=byName.get(name);
    let currentTypeKey = 'standard';
    for (const d of list) {
      const o = overrides.get(d.recordIndex);
      if (o && o.baseType) {
        currentTypeKey = o.baseType;
        break;
      }
    }
    if (!currentTypeKey) currentTypeKey = 'standard';
const rowsHtml = list.map(item=>{
  const isWeekend = item.weekday==='åœŸ'||item.weekday==='æ—¥';
  const dateCls   = 'date-cell'+(isWeekend?' weekend':'');
  const overText  = item.extMinutes>0?item.extMinutes+'åˆ†':'-';
  const extText   = item.extUnits
    ? `${item.extFee.toLocaleString()}å††`
    : '0å††';
  const totalText = item.totalFee.toLocaleString()+'å††';
  const rowTypeClass =
    item.typeKey === 'short'   ? 'row-short'  :
    item.typeKey === '1gou'    ? 'row-1gou'   :
    item.typeKey === '2gou'    ? 'row-2gou'   :
    item.typeKey === '3gou'    ? 'row-3gou'   :
    'row-standard';
  const vacationCls = item.isVacation ? ' row-vacation' : ''; // [VACATION]
  const o = overrides.get(item.recordIndex) || {};
  const hasTypeOverride  = !!o.type;
  const hasTimeOverride  = (o.arriveMinutes != null) || (o.leaveMinutes != null);
  const typeClass = hasTypeOverride
    ? 'day-tag day-tag-type active'
    : 'day-tag day-tag-type';
  const timeClass = hasTimeOverride
    ? 'day-tag day-tag-time active'
    : 'day-tag day-tag-time';
  const vacationTag = item.isVacation                 // [VACATION]
    ? '<span class="day-tag day-tag-vacation active">é•·æœŸä¼‘æš‡</span>'  // [VACATION]
    : '';                                             // [VACATION]
  const dayTagsHtml =
    '<span class="'+typeClass+'">åŒºåˆ†å¤‰æ›´</span>'+
    '<span class="'+timeClass+'">æ™‚é–“å¤‰æ›´</span>'+
    vacationTag;
  // å‚™è€ƒ
  let remark = '';
  let remarkForCopy = '';
  if (item.extMinutes > 0) {
    const fee = item.extFee.toLocaleString() + 'å††/' + item.extMinutes + 'åˆ†';
    if (item.arrive && item.leave) {
      remark =
        'å»¶é•·æ™‚é–“ï¼š\n' +
        (item.arrive + 'ï½' + item.leave) + '\n' +
        fee;
      remarkForCopy = 'å»¶é•·æ™‚é–“ï¼š ' + item.arrive + 'ï½' + item.leave + ' ' + fee;
    } else {
      remark =
        'å»¶é•·æ™‚é–“ï¼š\n' +
        fee;
      remarkForCopy = 'å»¶é•·æ™‚é–“ï¼š ' + fee;
    }
  }
  const hasOverride   = overrides.has(item.recordIndex);
  const baseStatus    = (originalStatusList[item.recordIndex] || '').trim();
  const statusChanged = baseStatus && baseStatus !== (item.attendLabel || '');
  const hasChange     = hasOverride || statusChanged;
  const safeHtml = escapeHtml(remark).replace(/\n/g, '<br>');
  const safeCopy = escapeHtml(remarkForCopy);
  const remarkHtml =
    '<div class="remark-text">' + safeHtml + '</div>' +
    '<div class="remark-actions">' +
      '<button type="button" class="small copyRemarkBtn" data-remark="' + safeCopy + '">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>' +
      '<button type="button" class="resetRowBtn ' +
        (hasChange ? 'has-change' : 'no-change') +
        '" data-index="' + item.recordIndex + '">â†© å…ƒã«æˆ»ã™</button>' +
    '</div>';
  // â˜… é ã‹ã‚Šä¿è‚²ï¼ˆã„ã¾ã¯ 0 åˆæœŸã§ã‚‚OKï¼‰
  const azukariMinutes = item.azukariMinutes || 0;
  const azukariFee     = item.azukariFee     || 0;
  return (
    '<tr class="detail-row '+rowTypeClass+vacationCls+'" data-index="'+item.recordIndex+'">'+
      '<td class="col-year '+dateCls+'">'+escapeHtml(item.year)+'</td>'+
      '<td class="col-month '+dateCls+'">'+escapeHtml(item.month)+'</td>'+
      '<td class="col-day '+dateCls+' day-cell" data-index="'+item.recordIndex+'">'+
        '<div class="daycard status-' +
          (item.attendLabel === "ä¼‘åœ’" ? "closed" :
           item.attendLabel === "æ¬ åœ’" ? "absent" :
           item.attendLabel === "é•·æœŸä¼‘æš‡" ? "vacation" :  // [VACATION]
           "attend") +
          ' type-' + item.typeKey +
        '">'+
          '<div class="daycard-week">'+escapeHtml(item.weekday||'')+'</div>'+
          '<div class="daycard-date">'+escapeHtml(item.day)+'</div>'+
          '<div class="daycard-status"><span class="status-pill '
            + (item.attendLabel === "ç™»åœ’" ? "status-pill-attend"
              : item.attendLabel === "æ¬ åœ’" ? "status-pill-absent"
              : item.attendLabel === "ä¼‘åœ’" ? "status-pill-closed"
              : item.attendLabel === "é™åœ’" ? "status-pill-leave"
              : item.attendLabel === "é•·æœŸä¼‘æš‡" ? "status-pill-vacation"  // [VACATION]
              : "")
            + '">'+escapeHtml(item.attendLabel || "ç™»åœ’")+'</span></div>'+
          '<div class="daycard-tags">'+dayTagsHtml+'</div>'+
        '</div>'+
      '</td>'+
      '<td class="col-weekday">'+escapeHtml(item.weekday||'')+'</td>'+
      // åŒºåˆ†
      '<td class="col-type">'+
        '<div class="type-toggle" data-index="'+item.recordIndex+'">'+
          '<button type="button" class="small typeBtn type-standard '
            +(item.typeKey==='standard'?'active':'')+
            '" data-type="standard">'+
              '<span>æ¨™æº–æ™‚é–“</span>'+
              '<span>7:30ã€œ18:30</span>'+
          '</button>'+
          '<button type="button" class="small typeBtn type-short '
            +(item.typeKey==='short'?'active':'')+
            '" data-type="short">'+
              '<span>çŸ­æ™‚é–“</span>'+
              '<span>8:30ã€œ16:30</span>'+
          '</button>'+
          '<button type="button" class="small typeBtn type-1gou '
            +(item.typeKey==='1gou'?'active':'')+
            '" data-type="1gou">'+
              '<span>1å·èªå®š</span>'+
              '<span>8:30ã€œ16:00</span>'+
          '</button>'+
        '</div>'+
      '</td>'+
      '<td class="col-end">'+item.baseEnd+'</td>'+
      '<td class="col-buffer">'+item.buffer+'</td>'+
      // ç™»åœ’
      '<td class="col-arrive time-cell">'+
        '<input class="arriveInput time-input" data-index="'+item.recordIndex+'" type="text" value="'+(item.arrive||'')+'" />'+
        '<div class="muted" style="font-size:11px;">'+diffText(item.deltaArrive)+'</div>'+
        '<div class="time-buttons">'+
          '<div class="time-buttons-row row-5">'+
            '<button type="button" class="timeAdjustBtn small" data-target="arrive" data-index="'+item.recordIndex+'" data-delta="-5">-5åˆ†</button>'+
            '<button type="button" class="timeAdjustBtn small" data-target="arrive" data-index="'+item.recordIndex+'" data-delta="5">+5åˆ†</button>'+
          '</div>'+
          '<div class="time-buttons-row row-1">'+
            '<button type="button" class="timeAdjustBtn small" data-target="arrive" data-index="'+item.recordIndex+'" data-delta="-1">-1åˆ†</button>'+
            '<button type="button" class="timeAdjustBtn small" data-target="arrive" data-index="'+item.recordIndex+'" data-delta="1">+1åˆ†</button>'+
          '</div>'+
        '</div>'+
      '</td>'+
      // é™åœ’æ™‚åˆ»
      '<td class="col-leave time-cell">'+
        '<input class="leaveInput time-input" data-index="'+item.recordIndex+'" type="text" value="'+(item.leave||'')+'" />'+
        '<div class="muted" style="font-size:11px;">'+diffText(item.deltaLeave)+'</div>'+
        '<div class="time-buttons">'+
          '<div class="time-buttons-row row-5">'+
            '<button type="button" class="timeAdjustBtn small" data-target="leave" data-index="'+item.recordIndex+'" data-delta="-5">-5åˆ†</button>'+
            '<button type="button" class="timeAdjustBtn small" data-target="leave" data-index="'+item.recordIndex+'" data-delta="5">+5åˆ†</button>'+
          '</div>'+
          '<div class="time-buttons-row row-1">'+
            '<button type="button" class="timeAdjustBtn small" data-target="leave" data-index="'+item.recordIndex+'" data-delta="-1">-1åˆ†</button>'+
            '<button type="button" class="timeAdjustBtn small" data-target="leave" data-index="'+item.recordIndex+'" data-delta="1">+1åˆ†</button>'+
          '</div>'+
        '</div>'+
      '</td>'+
      // â˜… é ã‹ã‚Šä¿è‚²
      '<td class="col-azukari">'+
        '<div class="azukari-box" data-index="'+item.recordIndex+'">'+
          '<div class="azukari-total">'+azukariMinutes+'åˆ†</div>'+
          '<div class="azukari-buttons">'+
            '<button type="button" class="azukariBtn minus" data-index="'+item.recordIndex+'" data-delta="-15">-15åˆ†</button>'+
            '<button type="button" class="azukariBtn plus"  data-index="'+item.recordIndex+'" data-delta="15">+15åˆ†</button>'+
          '</div>'+
        '</div>'+
      '</td>'+
      '<td class="col-over">'+overText+'</td>'+
      '<td class="col-extu">'+item.extUnits+'</td>'+
      '<td class="col-extf">'+extText+'</td>'+
      // â˜… é ã‹ã‚Šä¿è‚²æ–™é‡‘ï¼ˆå°†æ¥è¨ˆç®—ã«ä½¿ã†ï¼šä»Šã¯ 0 ã§ã‚‚OKï¼‰
      '<td class="col-azukarif">'+azukariFee+'å††</td>'+
      '<td class="col-totalf">'+totalText+'</td>'+
      '<td class="col-remark">'+remarkHtml+'</td>'+
    '</tr>'
  );
}).join('');
    panelsHtml +=
      '<div class="tab-panel'+(idx===activeIndex?' active':'')+'" id="person-'+idx+'">'+
        '<div class="person-type-toggle">'+
          '<span class="muted" style="margin-right:4px;">åŸºæœ¬åŒºåˆ†:</span>'+
          '<button type="button" class="personTypeBtn'
            +(currentTypeKey==='standard'?' active':'')+
            '" data-name="'+escapeHtml(name)+'" data-type="standard">æ¨™æº–æ™‚é–“</button>'+
          '<button type="button" class="personTypeBtn'
            +(currentTypeKey==='short'?' active':'')+
            '" data-name="'+escapeHtml(name)+'" data-type="short">çŸ­æ™‚é–“</button>'+
          '<button type="button" class="personTypeBtn'
            +(currentTypeKey==='1gou'?' active':'')+
            '" data-name="'+escapeHtml(name)+'" data-type="1gou">1å·èªå®š</button>'+
        '</div>'+
        '<table>'+
          '<caption>'+escapeHtml(name)+' ã•ã‚“ã®æ—¥æ¬¡æ˜ç´°</caption>'+
'<thead><tr>'+
  '<th class="col-year">å¹´</th>'+
  '<th class="col-month">æœˆ</th>'+
  '<th class="col-day">æ—¥</th>'+
  '<th class="col-weekday">æ›œ</th>'+
  '<th class="col-type">åŒºåˆ†</th>'+
  '<th class="col-end">åŸºæº–çµ‚äº†</th>'+
  '<th class="col-buffer">ãƒãƒƒãƒ•ã‚¡</th>'+
  '<th class="col-arrive">ç™»åœ’æ™‚åˆ»</th>'+
  '<th class="col-leave">é™åœ’æ™‚åˆ»</th>'+
  // â˜… æ–°åˆ—ï¼šé ã‹ã‚Šä¿è‚²
  '<th class="col-azukari">é ã‹ã‚Šä¿è‚²</th>'+
  '<th class="col-over">å»¶é•·æ™‚é–“(åˆ†)</th>'+
  '<th class="col-extu">å»¶é•·å›æ•°</th>'+
  '<th class="col-extf">å»¶é•·ä¿è‚²æ–™é‡‘</th>'+
  // â˜… æ–°åˆ—ï¼šé ã‹ã‚Šä¿è‚²æ–™é‡‘
  '<th class="col-azukarif">é ã‹ã‚Šä¿è‚²æ–™é‡‘</th>'+
  '<th class="col-totalf">åˆè¨ˆæ–™é‡‘</th>'+
  '<th class="col-remark">å‚™è€ƒ</th>'+
'</tr></thead>'+
          '<tbody>'+rowsHtml+'</tbody>'+
        '</table>'+
      '</div>';
  });
// å®Ÿéš›ã«æç”»
detailContainer.innerHTML = headerHtml + panelsHtml;
// â˜… ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’åæ˜ ï¼ˆã“ã“ã ã‘ã§OKï¼‰
applyColumnVisibility();
  // ===== 4) ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š =====
  // åœ’ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯
  const schoolTabsEl = detailContainer.querySelectorAll('.school-tab');
  schoolTabsEl.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const sc = btn.getAttribute('data-school');
      lastSelectedSchool = sc;
      lastSelectedClass  = null;
      renderDetails(details);
    });
  });
  // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯
  const classTabsEl = detailContainer.querySelectorAll('.class-tab');
  classTabsEl.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const cl = btn.getAttribute('data-class');
      lastSelectedClass = cl;
      renderDetails(details);
    });
  });
  // ï¼ˆã“ã®ä¸‹ã® tab-button / timeAdjustBtn / personTypeBtn ãªã©ã¯ä»Šã®ã¾ã¾ã§OKï¼‰
  // æ°åã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
  const tabButtons=detailContainer.querySelectorAll('.tab-button');
  const tabPanels =detailContainer.querySelectorAll('.tab-panel');
  tabButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.getAttribute('data-tab');
      tabButtons.forEach(b=>b.classList.remove('active'));
      tabPanels.forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      const p=detailContainer.querySelector('#'+id);
      if(p) p.classList.add('active');
    });
  });
  // è¡Œã‚¯ãƒªãƒƒã‚¯ â†’ è¦‹ãŸç›®ã ã‘é¸æŠ
  const rowsEl=detailContainer.querySelectorAll('tbody tr.detail-row');
  rowsEl.forEach(tr=>{
    tr.addEventListener('click',()=>{
      rowsEl.forEach(r=>r.classList.remove('row-selected'));
      tr.classList.add('row-selected');
    });
  });
  // å‚™è€ƒã‚³ãƒ”ãƒ¼
  const copyButtons = detailContainer.querySelectorAll('.copyRemarkBtn');
  copyButtons.forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.stopPropagation();
      const text = btn.getAttribute('data-remark') || '';
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(()=>{});
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); } catch(e) {}
        document.body.removeChild(ta);
      }
      showCopyToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      btn.classList.add('active');
      setTimeout(()=>btn.classList.remove('active'),300);
    });
  });
  // ï¼‹5 / âˆ’5 ãƒœã‚¿ãƒ³
  const timeButtons=detailContainer.querySelectorAll('.timeAdjustBtn');
  timeButtons.forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.stopPropagation();
      if(!lastResult) return;
      const idx   = Number(btn.getAttribute('data-index'));
      const delta = Number(btn.getAttribute('data-delta')) || 0;
      const target= btn.getAttribute('data-target') || 'leave';
      const d = lastResult.details.find(x=>x.recordIndex===idx);
      if(!d) return;
      const baseTime = target==='arrive' ? d.arrive : d.leave;
      if(!baseTime) return;
      const curMin = parseTimeToMinutes(baseTime);
      if(curMin==null) return;
      let newMin = curMin + delta;
      if(newMin<0) newMin=0;
      if(newMin>=24*60) newMin=23*60+59;
      const before = baseTime;
      const after  = minutesToTime(newMin);
      const prev   = overrides.get(idx)||{};
      const originalRow = originalRows[idx] || {};
      if(target==='arrive'){
        const baseStr = (originalRow[columns.arrive] || '').trim();
        const baseMin = parseTimeToMinutes(baseStr);
        if (baseMin === newMin) {
          clearOverrideField(idx, 'arriveMinutes');
        } else {
          overrides.set(idx,{...prev,arriveMinutes:newMin});
        }
        addLog({recordIndex:idx,name:d.name,date:d.date,kind:'ç™»åœ’æ™‚é–“å¤‰æ›´',before,after});
      }else{
        const baseStr = (originalRow[columns.leave] || '').trim();
        const baseMin = parseTimeToMinutes(baseStr);
        if (baseMin === newMin) {
          clearOverrideField(idx, 'leaveMinutes');
        } else {
          overrides.set(idx,{...prev,leaveMinutes:newMin});
        }
        addLog({recordIndex:idx,name:d.name,date:d.date,kind:'é™åœ’æ™‚é–“å¤‰æ›´',before,after});
      }
      saveStateToStorage(); // [AZUKARI]
      const result=calculate(originalRows,originalBuffer);
      lastResult=result;
      renderSummary(result.summary);
      renderDetails(result.details);
    });
  });
  // [AZUKARI] é ã‚Šä¿è‚² +/- ãƒœã‚¿ãƒ³
  const azButtons = detailContainer.querySelectorAll('.azukariBtn');
  azButtons.forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.stopPropagation();
      if(!lastResult) return;
      const idx   = Number(btn.getAttribute('data-index'));
      const delta = Number(btn.getAttribute('data-delta')) || 0;
      const d = lastResult.details.find(x=>x.recordIndex===idx);
      if(!d) return;
      const prev = overrides.get(idx) || {};
      const before = prev.azukariMinutes || 0;
      let next = before + delta;
      if (next < 0) next = 0;
      if (next === 0) {
        clearOverrideField(idx, 'azukariMinutes');
      } else {
        overrides.set(idx, { ...prev, azukariMinutes: next });
      }
      addLog({
        recordIndex: idx,
        name: d.name,
        date: d.date,
        kind: "é ã‚Šä¿è‚²å¤‰æ›´", // [AZUKARI]
        before: `${before}åˆ†`,
        after: `${next}åˆ†`
      });
      saveStateToStorage(); // [AZUKARI]
      const result = calculate(originalRows, originalBuffer);
      lastResult = result;
      renderSummary(result.summary);
      renderDetails(result.details);
    });
  });
// â˜… åŸºæœ¬åŒºåˆ†ãƒœã‚¿ãƒ³ï¼ˆpersonTypeBtnï¼‰ â†’ å…¨è¡Œã¸é©ç”¨
const personTypeButtons = detailContainer.querySelectorAll('.personTypeBtn');
personTypeButtons.forEach(btn=>{
  btn.addEventListener('click',(e)=>{
    e.stopPropagation();
    if (!lastResult) return;
    const childName = btn.getAttribute('data-name');
    const newType   = btn.getAttribute('data-type');
    // ã“ã®å­ã®å…¨è¡Œã‚’å‡¦ç†
    lastResult.details.forEach(d=>{
      if (d.name === childName) {
        const idx  = d.recordIndex;
        const prev = overrides.get(idx) || {};
        // å¤‰åŒ–ãªã—ãªã‚‰ override ã‚’å‰Šé™¤
        if (newType === (prev.baseType || detectType(childName))) {
          clearOverrideField(idx, 'baseType');
          clearOverrideField(idx, 'type');
        } else {
          overrides.set(idx, { ...prev, baseType:newType });
        }
        addLog({
          recordIndex: idx,
          name: d.name,
          date: d.date,
          kind: "åŸºæœ¬åŒºåˆ†å¤‰æ›´(å…¨è¡Œ)",
          before: d.type,
          after:
            newType === "short" ? "çŸ­æ™‚é–“" :
            newType === "1gou"  ? "1å·èªå®š" :
            "æ¨™æº–æ™‚é–“"
        });
      }
    });
    // å†è¨ˆç®— + å†æç”»
    saveStateToStorage(); // [AZUKARI]
    const result = calculate(originalRows, originalBuffer);
    lastResult = result;
    renderSummary(result.summary);
    renderDetails(result.details);
  });
});
  // åŒºåˆ†ãƒœã‚¿ãƒ³
  const typeButtons = detailContainer.querySelectorAll('.typeBtn');
  typeButtons.forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.stopPropagation();
      if(!lastResult) return;
      const idx     = Number(btn.closest('tr').getAttribute('data-index'));
      const newType = btn.getAttribute('data-type'); // 'standard' / 'short' / '1gou'
      const d       = lastResult.details.find(x=>x.recordIndex===idx);
      if(!d) return;
      const prev     = overrides.get(idx) || {};
      const baseType = prev.baseType || detectType(d.name);
      if (newType === baseType) {
        // å…ƒã®åŸºæœ¬åŒºåˆ†ã¨åŒã˜ãªã‚‰ä¸Šæ›¸ãè§£é™¤
        clearOverrideField(idx, 'type');
      } else {
        overrides.set(idx, { ...prev, type:newType });
      }
      addLog({
        recordIndex: idx,
        name: d.name,
        date: d.date,
        kind: "åŒºåˆ†å¤‰æ›´",
        before: d.type,
        after:
          newType === 'short' ? 'çŸ­æ™‚é–“' :
          newType === '1gou'  ? '1å·èªå®š' :
                                'æ¨™æº–æ™‚é–“'
      });
      // â˜… åŒºåˆ†å¤‰æ›´å¾Œã«å†è¨ˆç®—ï¼‹å†æç”»
      saveStateToStorage(); // [AZUKARI]
      const result = calculate(originalRows, originalBuffer);
      lastResult   = result;
      renderSummary(result.summary);
      renderDetails(result.details);
    });
  });
  // å…ƒã«æˆ»ã™ãƒœã‚¿ãƒ³ï¼ˆæ—¥ã”ã¨ï¼‰
  const resetButtons = detailContainer.querySelectorAll('.resetRowBtn');
  resetButtons.forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      e.stopPropagation();
      if (!lastResult) return;
      const idx = Number(btn.getAttribute('data-index') || '-1');
      if (idx < 0) return;
      const backupRow = originalRowsBackup[idx];
      if (!backupRow) return;
      overrides.delete(idx);
      originalRows[idx] = { ...backupRow };
      addLog({
        recordIndex: idx,
        name: backupRow[columns.name] || '',
        date: backupRow[columns.date] || '',
        kind: "å…ƒã«æˆ»ã™",
        before: "ç·¨é›†å¾Œ",
        after: "åˆæœŸçŠ¶æ…‹"
      });
      saveStateToStorage(); // [AZUKARI]
      const result = calculate(originalRows, originalBuffer);
      lastResult   = result;
      renderSummary(result.summary);
      renderDetails(result.details);
    });
  });
  // â€¦ã“ã“ã¾ã§ã§ detailContainer.innerHTML ã‚’ä½œã‚Šçµ‚ã‚ã£ã¦ã„ã‚‹å‰æâ€¦
  // â˜… æ°åã‚¿ãƒ–ï¼šå³ã‚¯ãƒªãƒƒã‚¯ã§ã‚¢ã‚¤ã‚³ãƒ³ãƒ”ãƒƒã‚«ãƒ¼è¡¨ç¤º
  const nameTabs = detailContainer.querySelectorAll('.tab-button');
  nameTabs.forEach(btn=>{
    btn.addEventListener('contextmenu',(e)=>{
      e.preventDefault();
      const childKey = btn.getAttribute('data-child-key');
      if (!childKey) return;
      currentIconChildKey = childKey;
      // ã‚¯ãƒªãƒƒã‚¯ä½ç½®ã®è¿‘ãã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
      if (iconPickerBackdrop) {
        iconPickerBackdrop.style.display = 'flex';
        iconPickerBackdrop.style.alignItems = 'flex-start';
        iconPickerBackdrop.style.justifyContent = 'flex-start';
        iconPicker.style.position = 'fixed';
        iconPicker.style.top  = (e.clientY + 8) + 'px';
        iconPicker.style.left = (e.clientX + 8) + 'px';
      }
    });
  });
  enhanceTables(detailContainer);
}
    // å¤‰æ›´å±¥æ­´
    function addLog({recordIndex,name,date,kind,before,after}){
      changeLogs.push({recordIndex,name,date,kind,before,after});
      renderLogs();
    }
    function renderLogs(){
      if(!changeLogs.length){
        logContainer.textContent='ã¾ã å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        logContainer.classList.add('muted');
        return;
      }
      logContainer.classList.remove('muted');
      const byDate=new Map();
      changeLogs.forEach((log,idx)=>{
        if(!byDate.has(log.date))byDate.set(log.date,{entries:[],tags:new Set()});
        const g=byDate.get(log.date);
        g.entries.push({...log,no:idx+1});
        g.tags.add(log.kind);
      });
      const dates=Array.from(byDate.keys()).sort();
      let html='';
      dates.forEach(date=>{
        const g=byDate.get(date);
        const tags=Array.from(g.tags).map(t=>'['+escapeHtml(t)+']').join(' ');
        html+='<div><strong>'+escapeHtml(date)+'</strong> '+tags+'</div>';
        html+='<ul class="log-list">';
        g.entries.forEach(log=>{
          html+='<li>'+log.no+'. '+escapeHtml(log.name)+'ï¼š'+escapeHtml(log.kind)+' '+escapeHtml(log.before)+' â†’ '+escapeHtml(log.after)+'</li>';
        });
        html+='</ul>';
      });
      logContainer.innerHTML=html;
    }
    function clearOverrideField(idx, field){
      const prev = overrides.get(idx);
      if (!prev) return;
      delete prev[field];
      if (!prev.baseType &&
      !prev.type &&
      prev.arriveMinutes == null &&
      prev.leaveMinutes == null &&
      prev.azukariMinutes == null) { // [AZUKARI]
        overrides.delete(idx);
      } else {
        overrides.set(idx, prev);
      }
    }
    function detectType(name){
      return 'standard';
    }
    function parseTimeToMinutes(text){
      if(!text)return null;
      const t=text.trim();
      const m=t.match(/^(\d{1,2}):(\d{2})$/);
      if(!m)return null;
      const h=Number(m[1]), mi=Number(m[2]);
      if(Number.isNaN(h)||Number.isNaN(mi))return null;
      if(mi<0||mi>59)return null;
      return h*60+mi;
    }
    function minutesToTime(mins){
      const h=String(Math.floor(mins/60)).padStart(2,'0');
      const m=String(mins%60).padStart(2,'0');
      return h+':'+m;
    }
    function getWeekdayLabel(dateStr){
      const d=new Date(dateStr.replace(/-/g,'/'));
      if(Number.isNaN(d.getTime()))return'';
      return['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.getDay()];
    }
    function splitYMD(rawDate){
      const m=rawDate.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
      if(!m)return{year:'',month:'',day:''};
      return{
        year:m[1],
        month:String(m[2]).padStart(2,'0'),
        day:String(m[3]).padStart(2,'0')
      };
    }
    function escapeHtml(v){
      return String(v)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
  </script>
</body>
</html>
