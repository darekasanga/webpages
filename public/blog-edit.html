<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>è¨˜äº‹ç·¨é›† | Emperor News</title>
<link rel="stylesheet" href="/assets/base.css">
<body>
  <script>
    (function enforceAdminSession() {
      const SESSION_KEY = "emperor_admin_token";
      const authed = sessionStorage.getItem(SESSION_KEY) === "active";
      if (!authed) {
        const destination = encodeURIComponent(location.pathname + location.search + location.hash);
        window.location.replace(`/admin.html?redirect=${destination}`);
      }
    })();
  </script>

  <header class="site-header">
    <div class="brand">
      <div class="logo">E</div>
      <div>
        <h1>è¨˜äº‹ç·¨é›†</h1>
        <p>å…¬é–‹ãƒ“ãƒ¥ãƒ¼ã¨ã¯åˆ¥ã®ç®¡ç†ç”¨ç·¨é›†ãƒšãƒ¼ã‚¸</p>
      </div>
    </div>
    <div class="actions">
      <a class="pill" href="/blog-list.html">å…¬é–‹ä¸€è¦§ã¸æˆ»ã‚‹</a>
      <a class="pill ghost" href="/admin.html">èªè¨¼ãƒšãƒ¼ã‚¸</a>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="inline-chips">
        <div class="badge" id="status">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</div>
        <div class="badge">ã‚¹ãƒãƒ›ã€œPCå¯¾å¿œ</div>
      </div>
      <h2 style="margin:0">è¨˜äº‹ã®æ–°è¦è¿½åŠ ãƒ»ç·¨é›†</h2>
      <p class="muted">ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ãƒ»ã‚¿ã‚°ãƒ»ã‚«ãƒãƒ¼ç”»åƒURLã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã—ã¾ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒ ã‚„ãƒªã‚¹ãƒˆã¯ã™ã¹ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã«é…ç½®ã—ã¾ã—ãŸã€‚</p>
      <div class="actions" style="justify-content: space-between; align-items: flex-start;">
        <button class="secondary" id="newBtn">æ–°è¦ä½œæˆ</button>
        <p class="tiny" id="helper">æ–°ã—ã„è¨˜äº‹ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
      </div>
    </section>

    <section class="panel stack">
      <div class="section-title">
        <h3>é…ç½®è¨­å®š</h3>
        <span class="tiny">æ³¨ç›®è¨˜äº‹ã¨å›ºå®šè¨˜äº‹ã‚’é¸æŠ</span>
      </div>
      <form class="stack" id="settingsForm">
        <div class="form-row">
          <label class="tiny" for="heroSelect">ãƒˆãƒƒãƒ—ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼ˆãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®å¼·èª¿æ ï¼‰</label>
          <select id="heroSelect"></select>
        </div>
        <div class="form-row">
          <label class="tiny" for="featuredSelect">æ³¨ç›®è¨˜äº‹ï¼ˆä¸€è¦§ã®ä¸€ç•ªä¸Šï¼‰</label>
          <select id="featuredSelect"></select>
        </div>
        <div class="form-row">
          <label class="tiny" for="homeFeaturedSelect">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®æ³¨ç›®è¨˜äº‹ï¼ˆæ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ  / æœ€å¤§4ä»¶ï¼‰</label>
          <select id="homeFeaturedSelect" multiple size="5"></select>
          <p class="tiny muted">Cmd/Ctrl + ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠã§ãã¾ã™ã€‚æœ€å¤§4ä»¶ã¾ã§å„ªå…ˆè¡¨ç¤ºã—ã¾ã™ã€‚</p>
        </div>
        <div class="form-row">
          <label class="tiny" for="homeLatestSelect">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®æœ€æ–°è¨˜äº‹ï¼ˆãƒªã‚¹ãƒˆè¡¨ç¤º / æœ€å¤§4ä»¶ï¼‰</label>
          <select id="homeLatestSelect" multiple size="5"></select>
          <p class="tiny muted">é¸æŠã•ã‚ŒãŸIDé †ã§è¡¨ç¤ºã—ã¾ã™ï¼ˆæœªé¸æŠã®å ´åˆã¯å…ˆé ­ã‹ã‚‰4ä»¶ï¼‰ã€‚</p>
        </div>
        <div class="form-row">
          <label class="tiny">å›ºå®šè¨˜äº‹ï¼ˆä¸€è¦§ã®æœ€ä¸‹éƒ¨ã«ä¸¦ã¹ã¾ã™ï¼‰</label>
          <div id="pinnedChoices" class="stack" style="gap:8px;"></div>
        </div>
        <div class="actions" style="justify-content: space-between; align-items: center; flex-wrap: wrap;">
          <button class="primary" type="submit">é…ç½®ã‚’ä¿å­˜</button>
          <span class="tiny" id="settingsStatus">ä¸€è¦§ãƒšãƒ¼ã‚¸ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</span>
        </div>
      </form>
    </section>

    <section class="panel stack">
      <div class="section-title">
        <h3>æ–‡è¨€è¨­å®š</h3>
        <span class="tiny">ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å„é …ç›®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰æ›´</span>
      </div>
      <form class="stack" id="copyForm">
        <div class="form-row" style="align-items: flex-start;">
          <div style="flex:1;">
            <label class="tiny" for="copySourceSelect">è¨˜äº‹IDã‹ã‚‰æ–‡è¨€ã‚’èª­ã¿è¾¼ã‚€</label>
            <select id="copySourceSelect"></select>
            <p class="tiny muted" id="copySourceStatus">å›ºå®šè¨˜äº‹ãƒ»ãƒ’ãƒ¼ãƒ­ãƒ¼ãƒ»ä¸€è¦§/å›ºå®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚‚IDã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚</p>
          </div>
          <button class="secondary" type="button" id="applyCopySource">åæ˜ </button>
        </div>
        <div class="grid-2" style="gap:12px;">
          <div class="form-row">
            <label class="tiny" for="heroTitle">ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input id="heroTitle" name="heroTitle">
          </div>
          <div class="form-row">
            <label class="tiny" for="heroBody">ãƒ’ãƒ¼ãƒ­ãƒ¼æœ¬æ–‡</label>
            <textarea id="heroBody" name="heroBody"></textarea>
          </div>
          <div class="form-row">
            <label class="tiny" for="listTitle">ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—</label>
            <input id="listTitle" name="listTitle">
          </div>
          <div class="form-row">
            <label class="tiny" for="listSubtitle">ä¸€è¦§ã‚»ã‚¯ã‚·ãƒ§ãƒ³è£œè¶³</label>
            <textarea id="listSubtitle" name="listSubtitle"></textarea>
          </div>
          <div class="form-row">
            <label class="tiny" for="pinnedTitle">å›ºå®šã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—</label>
            <input id="pinnedTitle" name="pinnedTitle">
          </div>
          <div class="form-row">
            <label class="tiny" for="pinnedSubtitle">å›ºå®šã‚»ã‚¯ã‚·ãƒ§ãƒ³è£œè¶³</label>
            <textarea id="pinnedSubtitle" name="pinnedSubtitle"></textarea>
          </div>
          <div class="form-row">
            <label class="tiny" for="tagTitle">ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰è¦‹å‡ºã—</label>
            <input id="tagTitle" name="tagTitle">
          </div>
          <div class="form-row">
            <label class="tiny" for="tagSubtitle">ã‚¿ã‚°ã‚¯ãƒ©ã‚¦ãƒ‰è£œè¶³</label>
            <textarea id="tagSubtitle" name="tagSubtitle"></textarea>
          </div>
        </div>
        <div class="actions" style="justify-content: space-between; align-items: center; flex-wrap: wrap;">
          <button class="primary" type="submit">æ–‡è¨€ã‚’ä¿å­˜</button>
          <span class="tiny" id="copyStatus">ä¸€è¦§ãƒšãƒ¼ã‚¸ã«å³æ™‚åæ˜ ã•ã‚Œã¾ã™ã€‚</span>
        </div>
      </form>

      <div class="stack" style="gap:12px;">
        <div class="section-title" style="align-items: flex-end;">
          <div>
            <h4 style="margin:0;">è¿½åŠ ã®æ–‡è¨€é …ç›®</h4>
            <p class="tiny" style="margin:4px 0 0;">å³ã‹ã‚‰ã‚¹ãƒ¯ã‚¤ãƒ—ã§å‰Šé™¤ã§ãã¾ã™ã€‚å¿…è¦ã«å¿œã˜ã¦æ–°è¦è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
          </div>
          <form class="stack" id="copyExtraForm" style="gap:6px; width:min(360px, 100%);">
            <label class="tiny" for="copyExtraInput" style="color: var(--muted);">è¿½è¨˜äº‹é …</label>
            <div class="flex" style="gap:8px; align-items: center;">
              <input id="copyExtraInput" name="copyExtra" placeholder="ä¾‹: ã‚¹ãƒãƒ›ã¯å³ã‚¹ãƒ¯ã‚¤ãƒ—ã§å‰Šé™¤" style="flex:1;">
              <button class="secondary" type="submit" id="copyAddBtn">è¿½åŠ </button>
            </div>
            <span class="tiny" id="copyExtraStatus">Enterã‚­ãƒ¼ã§ã‚‚è¿½åŠ ã§ãã¾ã™ã€‚</span>
          </form>
        </div>
        <div class="stack" id="copyList" style="gap:12px;"></div>
      </div>
    </section>

    <section class="panel stack">
      <div class="section-title">
        <h3>ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯ç®¡ç†</h3>
        <span class="tiny">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã‚«ãƒ¼ãƒ‰ã‚’ç·¨é›†ãƒ»å‰Šé™¤</span>
      </div>
      <form class="stack" id="pageLinkForm">
        <div class="grid-2" style="gap:12px;">
          <div class="form-row">
            <label class="tiny" for="pageLinkTitle">ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆçµµæ–‡å­—å«ã‚å¯ï¼‰</label>
            <input id="pageLinkTitle" name="pageLinkTitle" required placeholder="ğŸ“° è¨˜äº‹ãƒ“ãƒ¥ãƒ¼">
          </div>
          <div class="form-row">
            <label class="tiny" for="pageLinkUrl">URL</label>
            <input id="pageLinkUrl" name="pageLinkUrl" required placeholder="/blog-article.html">
          </div>
        </div>
        <div class="form-row">
          <label class="tiny" for="pageLinkDescription">èª¬æ˜</label>
          <textarea id="pageLinkDescription" name="pageLinkDescription" rows="3" placeholder="ãƒªãƒ³ã‚¯å…ˆã®è£œè¶³"></textarea>
        </div>
        <div class="actions" style="justify-content: space-between; align-items: center; flex-wrap: wrap;">
          <div class="flex" style="gap:8px;">
            <button class="primary" type="submit" id="pageLinkSave">ä¿å­˜</button>
            <button class="secondary" type="button" id="pageLinkReset">æ–°è¦è¿½åŠ ã«åˆ‡æ›¿</button>
          </div>
          <span class="tiny" id="pageLinkStatus">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ã‚«ãƒ¼ãƒ‰ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</span>
        </div>
      </form>
      <div class="stack" id="pageLinkList" style="gap:10px;"></div>
    </section>

    <section class="panel stack">
      <form class="stack" id="editorForm">
        <div class="form-row">
          <label for="title" class="tiny">ã‚¿ã‚¤ãƒˆãƒ«</label>
          <input id="title" name="title" required placeholder="è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«">
        </div>
        <div class="form-row">
          <label for="body" class="tiny">æœ¬æ–‡ (è¤‡æ•°æ®µè½ã¯ç©ºè¡Œã§åŒºåˆ‡ã£ã¦ãã ã•ã„)</label>
          <textarea id="body" name="body" required placeholder="æœ¬æ–‡ã‚’å…¥åŠ›"></textarea>
        </div>
        <div class="form-row">
          <label for="tags" class="tiny">ã‚¿ã‚° (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
          <input id="tags" name="tags" placeholder="iPhone, iPad, å…¬å¼LINE">
        </div>
        <div class="form-row">
          <label for="image" class="tiny">ã‚«ãƒãƒ¼ç”»åƒURL</label>
          <input id="image" name="image" type="url" placeholder="https://example.com/cover.jpg">
        </div>
        <div class="form-row">
          <label class="tiny" for="imageFile">ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (jpg / png)</label>
          <div class="stack" style="gap:8px;">
            <input id="imageFile" type="file" accept="image/*">
            <div class="flex" style="align-items:flex-end; justify-content: space-between; gap:12px;">
              <div id="imagePreview" class="thumb fallback" style="width: 140px; height: auto; aspect-ratio: 4/3; display: grid; place-items: center;">No image</div>
              <div class="stack" style="align-items:flex-end; gap:6px;">
                <button class="secondary" type="button" id="clearImage">ç”»åƒã‚’ã‚¯ãƒªã‚¢</button>
                <span class="tiny" id="imageStatus">URLå…¥åŠ›ã‹ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã§ã‚«ãƒãƒ¼ç”»åƒã‚’ç™»éŒ²ã§ãã¾ã™ã€‚</span>
              </div>
            </div>
          </div>
        </div>
        <div class="actions">
          <button class="primary" type="submit" id="saveBtn">ä¿å­˜ã™ã‚‹</button>
        </div>
      </form>
    </section>

    <section class="panel">
      <div class="section-title">
        <h3>ä¿å­˜æ¸ˆã¿ã®è¨˜äº‹</h3>
        <span class="tiny">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã•ã‚ŒãŸè¨˜äº‹ã‚’ç·¨é›†ã¾ãŸã¯å‰Šé™¤ã§ãã¾ã™ã€‚</span>
      </div>
      <div class="stack" id="articleList"></div>
    </section>
  </main>

<script src="/assets/lightbox.js"></script>
<script src="/assets/blog-data.js"></script>
<script>
  const SESSION_KEY = "emperor_admin_token";
  const form = document.getElementById("editorForm");
  const articleList = document.getElementById("articleList");
  const statusLabel = document.getElementById("status");
  const helper = document.getElementById("helper");
  const saveBtn = document.getElementById("saveBtn");
  const imageInput = document.getElementById("image");
  const imageFile = document.getElementById("imageFile");
  const imagePreview = document.getElementById("imagePreview");
  const imageStatus = document.getElementById("imageStatus");
  const clearImageBtn = document.getElementById("clearImage");
  const settingsForm = document.getElementById("settingsForm");
  const heroSelect = document.getElementById("heroSelect");
  const featuredSelect = document.getElementById("featuredSelect");
  const homeFeaturedSelect = document.getElementById("homeFeaturedSelect");
  const homeLatestSelect = document.getElementById("homeLatestSelect");
  const pinnedChoices = document.getElementById("pinnedChoices");
  const settingsStatus = document.getElementById("settingsStatus");
  const copyForm = document.getElementById("copyForm");
  const copyStatus = document.getElementById("copyStatus");
  const copyList = document.getElementById("copyList");
  const copyExtraForm = document.getElementById("copyExtraForm");
  const copyExtraInput = document.getElementById("copyExtraInput");
  const copyExtraStatus = document.getElementById("copyExtraStatus");
  const copySourceSelect = document.getElementById("copySourceSelect");
  const copySourceStatus = document.getElementById("copySourceStatus");
  const applyCopySourceBtn = document.getElementById("applyCopySource");
  const pageLinkForm = document.getElementById("pageLinkForm");
  const pageLinkTitle = document.getElementById("pageLinkTitle");
  const pageLinkUrl = document.getElementById("pageLinkUrl");
  const pageLinkDescription = document.getElementById("pageLinkDescription");
  const pageLinkStatus = document.getElementById("pageLinkStatus");
  const pageLinkList = document.getElementById("pageLinkList");
  const pageLinkReset = document.getElementById("pageLinkReset");
  let editingLinkId = null;
  let editingIdx = null;
  let imageData = "";

  function parseTags(input) {
    return input.split(/[\,\n]/).map(t => t.trim()).filter(Boolean);
  }

  function formatTags(tags) {
    return (tags || []).join(", ");
  }

  function setPreview(src) {
    imageData = src || "";
    if (!imageData) {
      imagePreview.classList.add("fallback");
      imagePreview.textContent = "No image";
      imagePreview.style.backgroundImage = "";
      imageStatus.textContent = "URLå…¥åŠ›ã‹ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã§ã‚«ãƒãƒ¼ç”»åƒã‚’ç™»éŒ²ã§ãã¾ã™ã€‚";
      return;
    }
    imagePreview.classList.remove("fallback");
    imagePreview.textContent = "";
    imagePreview.style.backgroundImage = `url(${imageData})`;
    imagePreview.style.backgroundSize = "cover";
    imagePreview.style.backgroundPosition = "center";
    imageStatus.textContent = "ä¿å­˜å¾Œã€å…¬é–‹ãƒ“ãƒ¥ãƒ¼ã§ã‚¿ãƒƒãƒ—æ‹¡å¤§ã§ãã¾ã™ã€‚";
  }

  function downscaleImage(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          const MAX_DIMENSION = 1200;
          const scale = Math.min(1, MAX_DIMENSION / Math.max(img.width, img.height));
          const targetWidth = Math.round(img.width * scale);
          const targetHeight = Math.round(img.height * scale);
          const canvas = document.createElement("canvas");
          canvas.width = targetWidth;
          canvas.height = targetHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
          const outputType = file.type === "image/png" ? "image/png" : "image/jpeg";
          const quality = outputType === "image/png" ? 0.9 : 0.85;
          const dataUrl = canvas.toDataURL(outputType, quality);
          resolve(dataUrl);
        };
        img.onerror = () => reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"));
        img.src = reader.result;
      };
      reader.onerror = () => reject(new Error("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"));
      reader.readAsDataURL(file);
    });
  }

  async function handleFileSelect(event) {
    const [file] = event.target.files || [];
    if (!file) return;
    if (!file.type.startsWith("image/")) {
      imageStatus.textContent = "ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
      return;
    }
    if (file.size > 3 * 1024 * 1024) {
      imageStatus.textContent = "3MBä»¥ä¸‹ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚";
      return;
    }
    imageStatus.textContent = "ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™â€¦";
    try {
      const scaled = await downscaleImage(file);
      imageInput.value = "";
      setPreview(scaled);
      imageStatus.textContent = "é•·è¾º1200pxã«è‡ªå‹•ãƒªã‚µã‚¤ã‚ºã—ã¦ä¿å­˜ã—ã¾ã™ã€‚";
    } catch (err) {
      imageStatus.textContent = err?.message || "ç”»åƒå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
  }

  function setSessionBadge() {
    const authed = sessionStorage.getItem(SESSION_KEY) === "active";
    statusLabel.textContent = authed ? "ãƒ­ã‚°ã‚¤ãƒ³ä¸­: admin" : "æœªãƒ­ã‚°ã‚¤ãƒ³";
  }

  function renderSettingsForm() {
    const articles = BlogData.loadArticles();
    const settings = BlogData.saveSettings(BlogData.loadSettings());
    heroSelect.innerHTML = "";
    featuredSelect.innerHTML = "";
    homeFeaturedSelect.innerHTML = "";
    homeLatestSelect.innerHTML = "";
    pinnedChoices.innerHTML = "";

    if (!articles.length) {
      heroSelect.innerHTML = '<option value="">è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</option>';
      featuredSelect.innerHTML = '<option value="">è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</option>';
      homeFeaturedSelect.innerHTML = '<option value="">è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</option>';
      homeLatestSelect.innerHTML = '<option value="">è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</option>';
      pinnedChoices.innerHTML = '<span class="tiny">è¨˜äº‹è¿½åŠ å¾Œã«è¨­å®šã§ãã¾ã™ã€‚</span>';
      copySourceSelect.innerHTML = '<option value="">è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“</option>';
      settingsStatus.textContent = "è¨˜äº‹ã‚’è¿½åŠ ã™ã‚‹ã¨è¨­å®šã§ãã¾ã™ã€‚";
      return;
    }

    const heroFallbackOpt = document.createElement("option");
    heroFallbackOpt.value = "";
    heroFallbackOpt.textContent = "æœªæŒ‡å®š (å…ˆé ­ã®è¨˜äº‹ã‚’è¡¨ç¤º)";
    heroSelect.appendChild(heroFallbackOpt);

    const fallbackOpt = document.createElement("option");
    fallbackOpt.value = "";
    fallbackOpt.textContent = "æœªæŒ‡å®š (å…ˆé ­ã®è¨˜äº‹ã‚’è¡¨ç¤º)";
    featuredSelect.appendChild(fallbackOpt);

    articles.forEach((article, idx) => {
      const heroOption = document.createElement("option");
      heroOption.value = String(idx);
      heroOption.textContent = `ID ${idx}: ${article.title || "ç„¡é¡Œ"}`;
      if (settings.heroId === idx) heroOption.selected = true;
      heroSelect.appendChild(heroOption);

      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `ID ${idx}: ${article.title || "ç„¡é¡Œ"}`;
      if (settings.featuredId === idx) opt.selected = true;
      featuredSelect.appendChild(opt);

      const featuredOpt = document.createElement("option");
      featuredOpt.value = String(idx);
      featuredOpt.textContent = `ID ${idx}: ${article.title || "ç„¡é¡Œ"}`;
      featuredOpt.selected = settings.homeFeaturedIds.includes(idx);
      homeFeaturedSelect.appendChild(featuredOpt);

      const latestOpt = document.createElement("option");
      latestOpt.value = String(idx);
      latestOpt.textContent = `ID ${idx}: ${article.title || "ç„¡é¡Œ"}`;
      latestOpt.selected = settings.homeLatestIds.includes(idx);
      homeLatestSelect.appendChild(latestOpt);
    });

    copySourceSelect.innerHTML = '<option value="">æ–‡è¨€ã‚’èª­ã¿è¾¼ã‚€è¨˜äº‹ã‚’é¸æŠ</option>';
    articles.forEach((article, idx) => {
      const opt = document.createElement("option");
      opt.value = String(idx);
      opt.textContent = `ID ${idx}: ${article.title || "ç„¡é¡Œ"}`;
      copySourceSelect.appendChild(opt);
    });

    articles.forEach((article, idx) => {
      const row = document.createElement("label");
      row.className = "flex";
      row.style.justifyContent = "space-between";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = String(idx);
      checkbox.checked = settings.footerIds.includes(idx);
      const text = document.createElement("span");
      text.textContent = `ID ${idx}: ${article.title || "ç„¡é¡Œ"}`;
      row.appendChild(text);
      row.appendChild(checkbox);
      pinnedChoices.appendChild(row);
    });

    settingsStatus.textContent = `ãƒ’ãƒ¼ãƒ­ãƒ¼: ${Number.isInteger(settings.heroId) ? `ID ${settings.heroId}` : "æœªæŒ‡å®š"} / æ³¨ç›®: ${Number.isInteger(settings.featuredId) ? `ID ${settings.featuredId}` : "æœªæŒ‡å®š"} / ãƒˆãƒƒãƒ—æ³¨ç›® ${settings.homeFeaturedIds.length} ä»¶ / ãƒˆãƒƒãƒ—æœ€æ–° ${settings.homeLatestIds.length} ä»¶ / å›ºå®š ${settings.footerIds.length} ä»¶`;
  }

  function renderCopyForm() {
    const copy = BlogData.loadCopy();
    Object.entries(copy).forEach(([key, value]) => {
      const input = copyForm.querySelector(`[name="${key}"]`);
      if (input) {
        input.value = value;
      }
    });
    copyStatus.textContent = "ä¸€è¦§ãƒšãƒ¼ã‚¸ã«å³æ™‚åæ˜ ã•ã‚Œã¾ã™ã€‚";
  }

  function applyCopySource() {
    const idx = parseInt(copySourceSelect.value, 10);
    if (!Number.isInteger(idx)) {
      copySourceStatus.textContent = "è¨˜äº‹IDã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
      return;
    }
    const { article } = BlogData.findArticle(idx);
    if (!article) {
      copySourceStatus.textContent = "è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
      return;
    }

    const title = article.title?.trim() || `è¨˜äº‹ID ${idx}`;
    const body = (article.body || "").split(/\n+/)[0].trim();
    const excerpt = body.slice(0, 120);

    const setters = {
      heroTitle: title,
      listTitle: title,
      pinnedTitle: title,
      heroBody: excerpt,
      listSubtitle: excerpt,
      pinnedSubtitle: excerpt,
    };

    Object.entries(setters).forEach(([key, value]) => {
      const input = copyForm.querySelector(`[name="${key}"]`);
      if (input) input.value = value;
    });

    copySourceStatus.textContent = `ID ${idx} ã®è¨˜äº‹ã‹ã‚‰æ–‡è¨€ã‚’åæ˜ ã—ã¾ã—ãŸã€‚`;
  }

  function renderCopyExtras() {
    const extras = BlogData.loadCopyExtras();
    copyList.innerHTML = "";
    if (!extras.length) {
      copyList.innerHTML = '<p class="muted">è¿½åŠ ã•ã‚ŒãŸæ–‡è¨€ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å³ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã§ãã¾ã™ã€‚</p>';
      return;
    }

    extras.forEach((item) => {
      const row = document.createElement("div");
      row.className = "swipeable";
      row.dataset.id = item.id;
      row.innerHTML = `
        <div class="swipe-delete">å‰Šé™¤</div>
        <div class="card swipe-body">
          <div class="actions" style="justify-content: space-between; align-items: flex-start;">
            <div class="stack" style="gap:4px;">
              <div class="badge">è¿½è¨˜</div>
              <span class="tiny">å³ã‹ã‚‰ã‚¹ãƒ¯ã‚¤ãƒ—ã§æ¶ˆã›ã¾ã™</span>
            </div>
            <button class="secondary" data-action="delete" data-id="${item.id}">å‰Šé™¤</button>
          </div>
          <p style="margin:0; color: var(--text);">${item.text}</p>
        </div>
      `;
      attachSwipeHandler(row, () => removeCopyExtra(item.id));
      copyList.appendChild(row);
    });
  }

  function removeCopyExtra(id) {
    const extras = BlogData.loadCopyExtras();
    const next = extras.filter((item) => item.id !== id);
    BlogData.saveCopyExtras(next);
    renderCopyExtras();
    copyExtraStatus.textContent = "å‰Šé™¤ã—ã¾ã—ãŸã€‚";
  }

  function handleCopyExtraAdd(event) {
    event.preventDefault();
    const text = copyExtraInput.value.trim();
    if (!text) {
      copyExtraStatus.textContent = "æ–‡è¨€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
      return;
    }
    const extras = BlogData.loadCopyExtras();
    const next = BlogData.saveCopyExtras([
      ...extras,
      { id: crypto.randomUUID?.() ?? `copy-${Date.now()}`, text },
    ]);
    copyExtraInput.value = "";
    copyExtraStatus.textContent = `${next.length}ä»¶ã®æ–‡è¨€ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`;
    renderCopyExtras();
  }

  function resetPageLinkForm(link = {}) {
    pageLinkTitle.value = link.title || "";
    pageLinkUrl.value = link.url || "";
    pageLinkDescription.value = link.description || "";
    editingLinkId = link.id ?? null;
    pageLinkStatus.textContent = editingLinkId ? `ID ${editingLinkId} ã‚’ç·¨é›†ä¸­ã§ã™ã€‚` : "ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®ã‚«ãƒ¼ãƒ‰ã«åæ˜ ã•ã‚Œã¾ã™ã€‚";
  }

  function renderPageLinks() {
    const links = BlogData.loadPageLinks();
    pageLinkList.innerHTML = "";
    if (!links.length) {
      pageLinkList.innerHTML = '<p class="muted">ãƒªãƒ³ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
      return;
    }
    links.forEach((link) => {
      const row = document.createElement("article");
      row.className = "swipeable";
      row.dataset.id = link.id;
      row.innerHTML = `
        <div class="swipe-delete">å‰Šé™¤</div>
        <div class="card swipe-body">
          <div class="actions" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
            <div class="stack" style="gap:6px;">
              <div class="inline-chips">
                <span class="badge">ID ${link.id}</span>
                <span class="badge">${link.url}</span>
              </div>
              <h3 style="margin:0;">${link.title}</h3>
              <p class="muted" style="margin:0;">${link.description || ""}</p>
            </div>
            <div class="stack" style="gap:6px; align-items:flex-end;">
              <button class="secondary" data-action="edit-link" data-id="${link.id}">ç·¨é›†</button>
              <button class="secondary" data-action="delete-link" data-id="${link.id}">å‰Šé™¤</button>
            </div>
          </div>
        </div>
      `;
      attachSwipeHandler(row, () => {
        const next = BlogData.loadPageLinks().filter((item) => item.id !== link.id);
        BlogData.savePageLinks(next);
        renderPageLinks();
        resetPageLinkForm();
        pageLinkStatus.textContent = `ID ${link.id} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`;
      });
      pageLinkList.appendChild(row);
    });
  }

  function handlePageLinkSave(event) {
    event.preventDefault();
    const title = pageLinkTitle.value.trim();
    const url = pageLinkUrl.value.trim();
    const description = pageLinkDescription.value.trim();
    if (!title || !url) {
      pageLinkStatus.textContent = "ã‚¿ã‚¤ãƒˆãƒ«ã¨URLã¯å¿…é ˆã§ã™ã€‚";
      return;
    }
    const links = BlogData.loadPageLinks();
    const id = editingLinkId ?? `link-${Date.now()}`;
    const next = links.filter((item) => item.id !== id);
    next.unshift({ id, title, url, description });
    const saved = BlogData.savePageLinks(next);
    renderPageLinks();
    resetPageLinkForm();
    pageLinkStatus.textContent = `${saved.length}ä»¶ã®ãƒªãƒ³ã‚¯ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚`;
  }

  function handlePageLinkListClick(event) {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    const { action, id } = target.dataset;
    if (!id) return;
    const links = BlogData.loadPageLinks();
    if (action === "edit-link") {
      const link = links.find((item) => item.id === id);
      if (link) {
        resetPageLinkForm(link);
      }
    }
    if (action === "delete-link") {
      const next = links.filter((item) => item.id !== id);
      BlogData.savePageLinks(next);
      renderPageLinks();
      resetPageLinkForm();
      pageLinkStatus.textContent = `ID ${id} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`;
    }
  }

  function attachSwipeHandler(element, onCommit) {
    const body = element.querySelector(".swipe-body");
    let startX = 0;
    let deltaX = 0;
    let dragging = false;

    function reset() {
      deltaX = 0;
      dragging = false;
      element.dataset.swipeReady = "";
      body.style.transform = "";
    }

    function handleEnd(event) {
      if (!dragging) return;
      element.releasePointerCapture?.(event.pointerId);
      const shouldCommit = deltaX > 110;
      reset();
      if (shouldCommit) onCommit?.();
    }

    element.addEventListener("pointerdown", (event) => {
      startX = event.clientX;
      dragging = true;
      element.setPointerCapture?.(event.pointerId);
    });

    element.addEventListener("pointermove", (event) => {
      if (!dragging) return;
      deltaX = Math.max(0, startX - event.clientX);
      if (!body) return;
      body.style.transform = `translateX(${-Math.min(deltaX, 120)}px)`;
      element.dataset.swipeReady = deltaX > 80 ? "true" : "";
    });

    element.addEventListener("pointerup", handleEnd);
    element.addEventListener("pointercancel", handleEnd);
  }

  function renderList() {
    const articles = BlogData.loadArticles();
    articleList.innerHTML = "";
    if (!articles.length) {
      articleList.innerHTML = '<p class="muted">ã¾ã è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>';
      return;
    }

    articles.forEach((article, idx) => {
      const item = document.createElement("div");
      item.className = "swipeable";
      item.dataset.idx = String(idx);
      item.innerHTML = `
        <div class="swipe-delete">å‰Šé™¤</div>
        <div class="card swipe-body">
          <div class="actions" style="justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
            <div class="stack" style="gap:6px;">
              <div class="inline-chips">
                <span class="badge">ID ${idx}</span>
                <span class="badge">${(article.tags || []).length || 0} ã‚¿ã‚°</span>
              </div>
              <h3 style="margin:0;">${article.title || "ç„¡é¡Œã®è¨˜äº‹"}</h3>
              <p class="muted">${article.body?.slice(0, 80) || "æœ¬æ–‡ãŒã‚ã‚Šã¾ã›ã‚“"}</p>
              <div class="tag-row">${(article.tags || []).map(tag => `<a class="tag" href="/tag.html?tag=${encodeURIComponent(tag)}">#${tag}</a>`).join("") || '<span class="tag">#untagged</span>'}</div>
            </div>
            <div class="stack" style="gap:6px; align-items:flex-end;">
              <button class="secondary" data-action="edit" data-idx="${idx}">ç·¨é›†</button>
              <button class="secondary" data-action="delete" data-idx="${idx}">å‰Šé™¤</button>
            </div>
          </div>
        </div>
      `;
      attachSwipeHandler(item, () => {
        if (confirm("ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          BlogData.deleteArticle(idx);
          renderList();
          renderSettingsForm();
        }
      });
      articleList.appendChild(item);
    });
  }

  function fillForm(article, idx) {
    document.getElementById("title").value = article?.title || "";
    document.getElementById("body").value = article?.body || "";
    document.getElementById("tags").value = formatTags(article?.tags);
    imageInput.value = article?.image || "";
    imageFile.value = "";
    setPreview(article?.image || "");
    editingIdx = Number.isInteger(idx) ? idx : null;
    helper.textContent = editingIdx === null ? "æ–°ã—ã„è¨˜äº‹ã‚’ä½œæˆã—ã¾ã™ã€‚" : `ID ${editingIdx} ã‚’ç·¨é›†ä¸­ã§ã™ã€‚`;
    saveBtn.textContent = editingIdx === null ? "ä¿å­˜ã™ã‚‹" : "æ›´æ–°ã™ã‚‹";
  }

  async function handleSave(event) {
    event.preventDefault();
    if (imageFile.files?.length && !imageData) {
      imageStatus.textContent = "ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºä¸­ã§ã™â€¦";
      try {
        const scaled = await downscaleImage(imageFile.files[0]);
        setPreview(scaled);
        imageStatus.textContent = "é•·è¾º1200pxã«è‡ªå‹•ãƒªã‚µã‚¤ã‚ºã—ã¦ä¿å­˜ã—ã¾ã™ã€‚";
      } catch (err) {
        imageStatus.textContent = err?.message || "ç”»åƒå‡¦ç†ã«å¤±æ•—ã¾ã—ãŸã€‚";
        return;
      }
    }
    const payload = {
      title: document.getElementById("title").value.trim(),
      body: document.getElementById("body").value.trim(),
      tags: parseTags(document.getElementById("tags").value),
      image: imageData || imageInput.value.trim(),
    };

    BlogData.upsertArticle(payload, editingIdx);
    fillForm({}, null);
    renderList();
    renderSettingsForm();
    alert("è¨˜äº‹ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
  }

  function handleListClick(event) {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    const idx = parseInt(target.dataset.idx, 10);
    if (!Number.isFinite(idx)) return;

    if (target.dataset.action === "edit") {
      const { article } = BlogData.findArticle(idx);
      fillForm(article, idx);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    if (target.dataset.action === "delete") {
      if (confirm("ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
        BlogData.deleteArticle(idx);
        renderList();
        renderSettingsForm();
      }
    }
  }

  function handleSettingsSave(event) {
    event.preventDefault();
    const heroId = heroSelect.value === "" ? null : parseInt(heroSelect.value, 10);
    const featuredId = featuredSelect.value === "" ? null : parseInt(featuredSelect.value, 10);
    const footerIds = Array.from(pinnedChoices.querySelectorAll('input[type="checkbox"]:checked'))
      .map((input) => parseInt(input.value, 10))
      .filter(Number.isInteger);
    const homeFeaturedIds = Array.from(homeFeaturedSelect.selectedOptions)
      .map((opt) => parseInt(opt.value, 10))
      .filter(Number.isInteger);
    const homeLatestIds = Array.from(homeLatestSelect.selectedOptions)
      .map((opt) => parseInt(opt.value, 10))
      .filter(Number.isInteger);
    const normalized = BlogData.saveSettings({ heroId, featuredId, footerIds, homeFeaturedIds, homeLatestIds });
    settingsStatus.textContent = `ãƒ’ãƒ¼ãƒ­ãƒ¼: ${Number.isInteger(normalized.heroId) ? `ID ${normalized.heroId}` : "æœªæŒ‡å®š"} / æ³¨ç›®: ${Number.isInteger(normalized.featuredId) ? `ID ${normalized.featuredId}` : "æœªæŒ‡å®š"} / ãƒˆãƒƒãƒ—æ³¨ç›® ${normalized.homeFeaturedIds.length} ä»¶ / ãƒˆãƒƒãƒ—æœ€æ–° ${normalized.homeLatestIds.length} ä»¶ / å›ºå®š ${normalized.footerIds.length} ä»¶ ä¿å­˜ã—ã¾ã—ãŸ`;
  }

  function handleCopySave(event) {
    event.preventDefault();
    const formData = new FormData(copyForm);
    const payload = {};
    for (const [key, value] of formData.entries()) {
      payload[key] = value;
    }
    const normalized = BlogData.saveCopy(payload);
    copyStatus.textContent = "ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒ–ãƒ­ã‚°ä¸€è¦§ã§å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚";
    Object.entries(normalized).forEach(([key, value]) => {
      const input = copyForm.querySelector(`[name="${key}"]`);
      if (input) input.value = value;
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    setSessionBadge();
    renderList();
    fillForm({}, null);
    renderSettingsForm();
    renderCopyForm();
    renderCopyExtras();
    renderPageLinks();
    resetPageLinkForm();
  });

  form.addEventListener("submit", handleSave);
  articleList.addEventListener("click", handleListClick);
  imageFile.addEventListener("change", handleFileSelect);
  imageInput.addEventListener("input", (event) => setPreview(event.target.value.trim()));
  clearImageBtn.addEventListener("click", () => {
    imageInput.value = "";
    imageFile.value = "";
    setPreview("");
  });
  document.getElementById("newBtn").addEventListener("click", () => fillForm({}, null));
  settingsForm.addEventListener("submit", handleSettingsSave);
  copyForm.addEventListener("submit", handleCopySave);
  copyExtraForm.addEventListener("submit", handleCopyExtraAdd);
  copyList.addEventListener("click", (event) => {
    const target = event.target;
    if (!(target instanceof HTMLElement)) return;
    if (target.dataset.action === "delete" && target.dataset.id) {
      removeCopyExtra(target.dataset.id);
    }
  });
  applyCopySourceBtn.addEventListener("click", applyCopySource);
  pageLinkForm.addEventListener("submit", handlePageLinkSave);
  pageLinkReset.addEventListener("click", () => resetPageLinkForm());
  pageLinkList.addEventListener("click", handlePageLinkListClick);
</script>
</body>
</html>
